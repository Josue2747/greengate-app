<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plataforma de Dilig√™ncia Pr√©via Ambiental</title>

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JRCHQBJEP1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-JRCHQBJEP1');

        // Track validation events
        function trackValidation(status, riskScore) {
            gtag('event', 'validation_complete', {
                'event_category': 'Validation',
                'event_label': status,
                'value': riskScore
            });
        }
    </script>

    <!-- Security Headers (ArcGIS-compatible CSP) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.arcgis.com https://*.arcgis.com https://www.googletagmanager.com https://www.google-analytics.com; worker-src 'self' blob: https://js.arcgis.com https://*.arcgis.com; style-src 'self' 'unsafe-inline' https://js.arcgis.com https://*.arcgis.com https://fonts.googleapis.com; font-src 'self' data: https://js.arcgis.com https://*.arcgis.com https://fonts.gstatic.com; img-src 'self' data: blob: https: https://*.arcgis.com https://*.arcgisonline.com https://www.google-analytics.com; connect-src 'self' https://api.greengate.com.br https://*.arcgis.com https://*.arcgisonline.com https://geocode.arcgis.com https://www.google-analytics.com https://analytics.google.com; child-src blob:; frame-ancestors 'none';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), payment=(), usb=()">

    <!-- HTTPS Redirect Enforcement -->
    <script>
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            location.replace('https:' + window.location.href.substring(window.location.protocol.length));
        }
    </script>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* SVG Icon Utility */
        .icon { width: 1em; height: 1em; display: inline-block; vertical-align: middle; }
        .icon-sm { width: 0.875em; height: 0.875em; }
        .icon-lg { width: 1.25em; height: 1.25em; }
        .icon-xl { width: 1.5em; height: 1.5em; }

        :root {
            --bg-primary: #0a0f1a; --bg-secondary: #111827; --bg-card: #1a2332; --bg-card-hover: #1f2937;
            --border-color: #2d3748; --text-primary: #f3f4f6; --text-secondary: #9ca3af; --text-muted: #6b7280;
            --accent-green: #10b981; --accent-green-dark: #059669; --accent-red: #ef4444; --accent-yellow: #f59e0b; --accent-blue: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 50%, #047857 100%);
            padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: space-between;
            position: relative; z-index: 100; height: 60px;
        }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .logo-text h1 { font-size: 1.1rem; font-weight: 700; }
        .logo-text span { font-size: 0.65rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .status-badge { display: flex; align-items: center; gap: 0.5rem; background: rgba(16, 185, 129, 0.2); border: 1px solid var(--accent-green); padding: 0.3rem 0.6rem; border-radius: 20px; font-size: 0.7rem; }
        .status-dot { width: 6px; height: 6px; background: var(--accent-green); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .help-trigger { width: 28px; height: 28px; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; background: rgba(255,255,255,0.1); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.9rem; font-weight: bold; }
        .help-trigger:hover { background: rgba(255,255,255,0.2); border-color: white; }

        /* LAYOUT */
        .main-container { display: grid; grid-template-columns: 1fr 400px; height: calc(100vh - 60px); }
        .map-container { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }

        /* SEARCH BAR - CENTRALIZADO NO TOPO */
        .search-box {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            width: 320px;
            max-width: calc(100vw - 120px);
        }
        .search-input-wrap {
            position: relative;
            background: rgba(26, 35, 50, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
        }
        .search-input-wrap:focus-within { border-color: var(--accent-green); }
        .search-input-wrap .icon { padding: 0 10px; color: var(--text-muted); }
        .search-input {
            flex: 1;
            padding: 10px 0;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 0.85rem;
            outline: none;
        }
        .search-input::placeholder { color: var(--text-muted); }
        .search-clear {
            padding: 0 10px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: none;
        }
        .search-clear.show { display: block; }
        .search-results {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0; right: 0;
            background: rgba(26, 35, 50, 0.98);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 220px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .search-results.show { display: block; }
        .search-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: var(--bg-card-hover); }
        .search-item-name { font-size: 0.85rem; color: var(--text-primary); }
        .search-item-type { font-size: 0.7rem; color: var(--text-muted); }
        .search-loading, .search-empty { padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; }

        /* MAP CONTROLS */
        .map-controls { position: absolute; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 50; }
        .map-btn { width: 40px; height: 40px; background: rgba(26, 35, 50, 0.95); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .map-btn:hover { background: var(--bg-card-hover); border-color: var(--accent-green); }
        .map-btn.active { background: var(--accent-green); border-color: var(--accent-green); color: white; }
        .draw-options { display: none; position: absolute; left: 48px; top: 0; flex-direction: row; gap: 6px; background: rgba(26, 35, 50, 0.95); padding: 4px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .draw-options.show { display: flex; }
        .draw-options .map-btn { width: 32px; height: 32px; font-size: 0.9rem; box-shadow: none; }
        #fullscreenBtn { display: none; }
        .close-fullscreen { display: none; position: absolute; top: 15px; right: 60px; z-index: 50; width: 40px; height: 40px; background: var(--accent-red); border: none; border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

        /* AREA INFO */
        .area-info { display: none; position: absolute; bottom: 25px; left: 15px; background: rgba(26, 35, 50, 0.95); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px 16px; z-index: 40; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 180px; }
        .area-info.show { display: block; }
        .area-info.limit-exceeded { border-color: var(--accent-red); background: rgba(239, 68, 68, 0.15); }
        .area-info-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .area-info-value { font-size: 1.4rem; font-weight: 700; color: var(--accent-green); margin-top: 4px; }
        .area-info.limit-exceeded .area-info-value { color: var(--accent-red); }
        .area-limit-text { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        .area-info.limit-exceeded .area-limit-text { color: var(--accent-red); font-weight: 600; }
        .area-coords { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; font-family: monospace; }
        .btn-export {
            margin-top: 10px;
            width: 100%;
            padding: 6px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-export:hover { border-color: var(--accent-green); color: var(--accent-green); }

        /* LEGEND */
        .map-legend { position: absolute; bottom: 25px; right: 15px; background: rgba(26, 35, 50, 0.95); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; z-index: 40; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .map-legend-title { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .legend-row { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        .legend-dot { width: 14px; height: 14px; border-radius: 3px; border: 2px solid; }
        .legend-dot.neutral { background: rgba(59,130,246,0.3); border-color: #3b82f6; }
        .legend-dot.approved { background: rgba(16,185,129,0.3); border-color: #10b981; }
        .legend-dot.warning { background: rgba(245,158,11,0.3); border-color: #f59e0b; }
        .legend-dot.rejected { background: rgba(239,68,68,0.3); border-color: #ef4444; }

        /* SIDEBAR */
        .sidebar { background: var(--bg-secondary); border-left: 1px solid var(--border-color); overflow-y: auto; padding: 20px; min-height: 0; }
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .card-title { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .card-title-icon { font-size: 1rem; }
        .card-title-right { margin-left: auto; }

        .input-wrapper { position: relative; }
        .input-wrapper input { width: 100%; padding: 12px 40px 12px 14px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem; }
        .input-wrapper input:focus { outline: none; border-color: var(--accent-green); }
        .input-eye { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; }

        .upload-area { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px 16px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 8px; }
        .upload-area:hover { border-color: var(--accent-green); background: rgba(16,185,129,0.05); }
        .upload-area.has-file { border-color: var(--accent-green); background: rgba(16,185,129,0.1); }
        .upload-area input { display: none; }
        .upload-icon { font-size: 2.5rem; line-height: 1; }
        .upload-text { font-size: 0.875rem; color: var(--text-secondary); }
        .upload-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 0; }
        .upload-filename { display: none; margin-top: 12px; padding: 8px 12px; background: var(--bg-card); border-radius: 6px; font-size: 0.75rem; color: var(--accent-green); word-break: break-all; }
        .upload-filename.show { display: block; }

        .btn-validate { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--accent-green), var(--accent-green-dark)); border: none; border-radius: 10px; color: white; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .btn-validate:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16,185,129,0.3); }
        .btn-validate:disabled { opacity: 0.5; cursor: not-allowed; }

        /* HISTORY */
        .history-list { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
        .history-empty { text-align: center; color: var(--text-muted); font-size: 0.8rem; padding: 15px; }
        .history-empty-cta { margin-top: 12px; padding: 8px 14px; background: var(--accent-blue); color: white; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer; }
        .history-empty-cta:hover { background: #2563eb; }

        /* Skeleton loader */
        .skeleton { background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-card-hover) 50%, var(--bg-card) 75%); background-size: 200% 100%; animation: loading 1.5s ease-in-out infinite; border-radius: 4px; display: inline-block; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-text { height: 1em; width: 60px; }
        .skeleton-date { height: 0.9em; width: 100px; }
        .history-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: border-color 0.15s;
        }
        .history-item:hover { border-color: var(--accent-blue); }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .history-status { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; }
        .history-status.approved { background: rgba(16,185,129,0.2); color: var(--accent-green); }
        .history-status.rejected { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        .history-status.warning { background: rgba(245,158,11,0.2); color: var(--accent-yellow); }
        .history-date { font-size: 0.65rem; color: var(--text-muted); }
        .history-info { font-size: 0.75rem; color: var(--text-secondary); }
        .btn-clear-history { background: none; border: none; color: var(--text-muted); font-size: 0.65rem; cursor: pointer; text-decoration: underline; }
        .btn-clear-history:hover { color: var(--accent-red); }

        /* MODAL DE AJUDA */
        .help-modal { display: none; position: fixed; inset: 0; background: rgba(10, 15, 26, 0.85); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .help-modal.show { display: flex; }
        .help-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; width: 100%; max-width: 500px; padding: 30px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-help { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; }
        .help-header { text-align: center; margin-bottom: 30px; }
        .help-icon { font-size: 3rem; margin-bottom: 10px; }
        .help-header h2 { font-size: 1.5rem; color: var(--text-primary); }
        .help-steps { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .step-item { display: flex; gap: 15px; align-items: flex-start; }
        .step-number { background: rgba(16, 185, 129, 0.1); color: var(--accent-green); width: 30px; height: 30px; flex-shrink: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 1px solid var(--accent-green); }
        .step-content h4 { color: var(--text-primary); margin-bottom: 4px; font-size: 1rem; }
        .step-content p { color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; }
        .btn-start { width: 100%; padding: 12px; background: var(--accent-green); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; }

        /* LOADING, RESULTS, CHECKS */
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(10,15,26,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        .loading-overlay.show { display: flex; }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid var(--border-color); border-top-color: var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; color: var(--text-secondary); }
        .loading-step { margin-top: 8px; color: var(--accent-green); font-weight: 500; }

        .result-card { display: none; }
        .result-card.show { display: block; }
        .result-banner { display: flex; align-items: center; gap: 12px; padding: 16px; border-radius: 10px; margin-bottom: 16px; }
        .result-banner.approved { background: rgba(16,185,129,0.15); border: 1px solid var(--accent-green); }
        .result-banner.rejected { background: rgba(239,68,68,0.15); border: 1px solid var(--accent-red); }
        .result-banner.warning { background: rgba(245,158,11,0.15); border: 1px solid var(--accent-yellow); }
        .result-icon { font-size: 2rem; }
        .result-title { font-size: 1.1rem; font-weight: 700; }
        .result-banner.approved .result-title { color: var(--accent-green); }
        .result-banner.rejected .result-title { color: var(--accent-red); }
        .result-banner.warning .result-title { color: var(--accent-yellow); }
        .result-subtitle { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }

        .compliance-section { background: var(--bg-primary); border-radius: 8px; padding: 14px; margin-bottom: 16px; }
        .compliance-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .compliance-bar { height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; }
        .compliance-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .compliance-fill.high { background: var(--accent-green); }
        .compliance-fill.medium { background: var(--accent-yellow); }
        .compliance-fill.low { background: var(--accent-red); }
        .compliance-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: var(--text-muted); }
        .compliance-row strong { font-size: 1.2rem; color: var(--text-primary); }

        .checks-list { display: flex; flex-direction: column; gap: 8px; }
        .check-row { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .check-row.fail { border-color: rgba(239,68,68,0.4); }
        .check-row.warning { border-color: rgba(245,158,11,0.4); }
        .check-header { display: flex; align-items: center; justify-content: space-between; padding: 12px; cursor: pointer; }
        .check-header:hover { background: var(--bg-card); }
        .check-left { display: flex; align-items: center; gap: 10px; }
        .check-status-icon { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .check-status-icon.pass { background: rgba(16,185,129,0.2); color: var(--accent-green); }
        .check-status-icon.fail { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        .check-status-icon.warning { background: rgba(245,158,11,0.2); color: var(--accent-yellow); }
        .check-status-icon.skip { background: rgba(107,114,128,0.2); color: var(--text-muted); }
        .check-name { font-size: 0.85rem; font-weight: 500; }
        .check-right { display: flex; align-items: center; gap: 8px; }
        .check-badge { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; padding: 3px 6px; border-radius: 4px; }
        .check-badge.pass { background: rgba(16,185,129,0.2); color: var(--accent-green); }
        .check-badge.fail { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        .check-badge.warning { background: rgba(245,158,11,0.2); color: var(--accent-yellow); }
        .check-badge.skip { background: rgba(107,114,128,0.2); color: var(--text-muted); }
        .check-arrow { color: var(--text-muted); font-size: 0.7rem; transition: transform 0.2s; }
        .check-row.open .check-arrow { transform: rotate(180deg); }
        .check-details { display: none; padding: 0 12px 12px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }
        .check-row.open .check-details { display: block; }
        .check-overlap-box { background: rgba(239,68,68,0.1); border-left: 3px solid var(--accent-red); padding: 10px; margin-top: 10px; border-radius: 0 6px 6px 0; font-size: 0.75rem; }
        .check-overlap-box strong { color: var(--accent-red); }

        .meta-row { display: flex; justify-content: space-between; padding-top: 12px; margin-top: 12px; border-top: 1px solid var(--border-color); font-size: 0.7rem; color: var(--text-muted); }
        .btn-pdf { width: 100%; padding: 12px; margin-top: 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-pdf:hover { border-color: var(--accent-green); color: var(--accent-green); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent-red); color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.85rem; z-index: 2001; opacity: 0; transition: all 0.3s; max-width: 90%; text-align: center; }
        .toast.success { background: var(--accent-green); }
        .toast.info { background: var(--accent-blue); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast a { color: white; text-decoration: underline; font-weight: 600; }

        /* GDPR Cookie Consent Banner */
        .cookie-consent {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 2px solid var(--accent-green);
            padding: 20px;
            z-index: 10000;
            display: none;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }
        .cookie-consent.show { display: block; }
        .cookie-consent-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        .cookie-consent-text {
            flex: 1;
            min-width: 300px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .cookie-consent-text a {
            color: var(--accent-green);
            text-decoration: underline;
        }
        .cookie-consent-buttons {
            display: flex;
            gap: 10px;
        }
        .cookie-consent-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .cookie-consent-btn.accept {
            background: var(--accent-green);
            color: white;
        }
        .cookie-consent-btn.accept:hover {
            background: var(--accent-green-dark);
        }
        .cookie-consent-btn.reject {
            background: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .cookie-consent-btn.reject:hover {
            background: var(--bg-card-hover);
        }

        body.fullscreen-mode .sidebar { display: none !important; }
        body.fullscreen-mode .main-container { grid-template-columns: 1fr !important; grid-template-rows: 1fr !important; height: 100vh !important; }
        body.fullscreen-mode .header { display: none !important; }
        body.fullscreen-mode .close-fullscreen { display: flex !important; align-items: center; justify-content: center; }

        /* Mobile - Tablets */
        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; grid-template-rows: 60vh 1fr; }
            .sidebar { border-left: none; border-top: 1px solid var(--border-color); max-height: 40vh; overflow-y: auto; }
            .map-controls { top: 10px; left: 10px; }
            .search-box { left: 50%; transform: translateX(-50%); width: calc(100% - 100px); max-width: 300px; }
            #fullscreenBtn { display: flex; }
            .map-legend { display: none; }
            .logo-text span { display: none; }
        }

        /* Mobile - Phones */
        @media (max-width: 600px) {
            .header { padding: 0.5rem 0.75rem; height: auto; min-height: 50px; }
            .logo-icon { width: 28px; height: 28px; }
            .logo-text h1 { font-size: 1.1rem !important; }
            .logo-text span { font-size: 0.6rem !important; }

            /* Header right - ajustar para mobile */
            .header-right {
                position: static !important;
                gap: 8px !important;
                margin-left: auto;
            }
            .status-badge {
                display: none !important; /* Esconder em mobile para economizar espa√ßo */
            }
            .help-trigger {
                width: 32px; height: 32px; font-size: 0.8rem;
            }
            #langToggleApp {
                padding: 4px 8px !important;
                font-size: 0.7rem !important;
                min-height: 32px;
            }

            .main-container { grid-template-rows: 55vh 1fr; }
            .sidebar { padding: 0.75rem; max-height: 45vh; }
            .sidebar-section { margin-bottom: 0.75rem; padding-bottom: 0.75rem; }
            .sidebar-section h3 { font-size: 0.8rem; margin-bottom: 0.5rem; }

            /* Bot√µes maiores para touch */
            .btn {
                padding: 0.75rem 1rem !important;
                font-size: 0.85rem !important;
                min-height: 44px; /* Apple HIG minimum touch target */
            }
            .btn-primary { padding: 0.875rem 1.25rem !important; font-size: 0.9rem !important; }

            /* Controles do mapa maiores */
            .map-controls button {
                width: 40px !important;
                height: 40px !important;
                font-size: 1.1rem !important;
            }

            /* Search box - posicionar √† direita, longe dos controles */
            .search-box {
                left: 70px;
                right: 50px;
                transform: none;
                width: auto;
                max-width: none;
                top: 8px;
            }
            .search-box input {
                padding: 0.5rem 0.6rem;
                font-size: 0.85rem;
            }

            /* Map controls - descer para ficar abaixo da search */
            .map-controls {
                top: 55px;
            }

            /* Draw options - abrir para direita em mobile */
            .draw-options {
                left: 48px !important;
                top: 0 !important;
                flex-direction: row !important;
            }

            /* Area info mais compacto */
            .area-info {
                padding: 0.4rem 0.6rem;
                min-width: auto;
                max-width: 140px;
                bottom: 10px;
                left: 10px;
            }
            .area-info-label { font-size: 0.55rem; }
            .area-info-value { font-size: 1rem; margin-top: 2px; }
            .area-limit-text { font-size: 0.55rem; }
            .area-coords { display: none; }
            .btn-export {
                margin-top: 6px;
                padding: 4px 6px;
                font-size: 0.6rem;
            }

            /* Steps mais compactos */
            .step { padding: 0.6rem; }
            .step-number { width: 24px; height: 24px; font-size: 0.7rem; }
            .step-content h4 { font-size: 0.8rem; }
            .step-content p { font-size: 0.7rem; line-height: 1.3; }

            /* Result card */
            .result-card { margin: 0.5rem 0; }
            .result-banner { padding: 0.75rem; }
            .result-banner h2 { font-size: 1.1rem; }

            /* Check items */
            .check-item { padding: 0.6rem; }
            .check-icon { width: 28px; height: 28px; }
            .check-name { font-size: 0.8rem; }
            .check-status { font-size: 0.7rem; padding: 0.2rem 0.5rem; }

            /* Data freshness card */
            #dataFreshnessCard { padding: 0.6rem; font-size: 0.75rem; }

            /* Modais */
            .modal-content {
                width: 95% !important;
                max-width: none !important;
                margin: 1rem !important;
                max-height: 90vh;
                overflow-y: auto;
            }
            .modal-header { padding: 0.75rem 1rem; }
            .modal-header h2 { font-size: 1rem; }
            .modal-body { padding: 0.75rem 1rem; }
            .form-group label { font-size: 0.8rem; }
            .form-group input, .form-group select {
                padding: 0.6rem;
                font-size: 0.9rem;
                min-height: 44px;
            }
        }

        /* Extra small phones */
        @media (max-width: 380px) {
            .header { padding: 0.25rem 0.5rem; }
            .logo-text h1 { font-size: 0.95rem !important; }
            .logo-text span { display: none !important; }
            .header-right { gap: 6px !important; }
            .help-trigger { width: 28px; height: 28px; font-size: 0.75rem; }
            #langToggleApp { padding: 3px 6px !important; font-size: 0.65rem !important; }
            .main-container { grid-template-rows: 50vh 1fr; }
            .btn { font-size: 0.8rem !important; }
        }
    </style>
</head>
<body>

<!-- SVG Icon Sprite -->
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path>
  </symbol>
  <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="20 6 9 17 4 12"></polyline>
  </symbol>
  <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
  </symbol>
  <symbol id="icon-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
    <line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>
  </symbol>
  <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
    <polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>
  </symbol>
  <symbol id="icon-file" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
    <polyline points="13 2 13 9 20 9"></polyline>
  </symbol>
  <symbol id="icon-target" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle>
  </symbol>
  <symbol id="icon-key" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
  </symbol>
  <symbol id="icon-upload" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
    <polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>
  </symbol>
  <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="3 6 5 6 21 6"></polyline>
    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
  </symbol>
  <symbol id="icon-location" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle>
  </symbol>
  <symbol id="icon-maximize" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
  </symbol>
  <symbol id="icon-help" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10"></circle>
    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line>
  </symbol>
  <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
  </symbol>
  <symbol id="icon-polygon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
    <polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline>
  </symbol>
  <symbol id="icon-rectangle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
  </symbol>
  <symbol id="icon-history" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
  </symbol>
  <symbol id="icon-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>
  </symbol>
  <symbol id="icon-eye-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
    <line x1="1" y1="1" x2="23" y2="23"></line>
  </symbol>
  <symbol id="icon-map" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
    <line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line>
  </symbol>
  <symbol id="icon-lock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
  </symbol>
  <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
    <line x1="16" y1="2" x2="16" y2="6"></line>
    <line x1="8" y1="2" x2="8" y2="6"></line>
    <line x1="3" y1="10" x2="21" y2="10"></line>
  </symbol>
</svg>

<header class="header" style="position: relative; display: flex; align-items: center; justify-content: center; height: 60px;">
    <div class="logo-text" style="text-align: center;">
        <h1 style="margin: 0; line-height: 1.2; font-size: 24px;">GreenGate</h1>
        <span style="font-size: 14px; display: block;" data-i18n-app="subtitle">Plataforma de Dilig√™ncia Pr√©via</span>
    </div>
    <div class="header-right" style="position: absolute; right: 20px; display: flex; align-items: center; gap: 15px;">
        <div class="status-badge"><span class="status-dot"></span> <span data-i18n-app="status">Sistema Ativo</span></div>
        <button class="help-trigger" id="helpBtn" title="Ajuda">?</button>
        <button id="langToggleApp" onclick="toggleAppLanguage()" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600;">PT</button>
    </div>
</header>

<div class="main-container">
    <div class="map-container">
        <div id="map"></div>

        <div class="map-controls">
            <div style="position: relative;">
                <button class="map-btn" id="drawBtn" data-i18n-app="drawBtn" title="Desenhar"><svg class="icon"><use href="#icon-edit"></use></svg></button>
                <div class="draw-options" id="drawOptions">
                    <button class="map-btn" id="drawPolygon" title="Pol√≠gono"><svg class="icon"><use href="#icon-polygon"></use></svg></button>
                    <button class="map-btn" id="drawRect" title="Ret√¢ngulo"><svg class="icon"><use href="#icon-rectangle"></use></svg></button>
                </div>
            </div>
            <button class="map-btn" id="clearBtn" data-i18n-app="clearBtn" title="Limpar"><svg class="icon"><use href="#icon-trash"></use></svg></button>
            <button class="map-btn" id="locateBtn" title="Localiza√ß√£o"><svg class="icon"><use href="#icon-location"></use></svg></button>
            <button class="map-btn" id="fullscreenBtn" title="Tela Cheia"><svg class="icon"><use href="#icon-maximize"></use></svg></button>
        </div>

        <!-- SEARCH -->
        <div class="search-box">
            <div class="search-input-wrap">
                <svg class="icon" style="margin-left: 10px;"><use href="#icon-search"></use></svg>
                <input type="text" class="search-input" id="searchInput" data-i18n-app="searchPlaceholder" placeholder="Buscar cidade ou estado...">
                <button class="search-clear" id="searchClear"><svg class="icon"><use href="#icon-x"></use></svg></button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>

        <button class="close-fullscreen" id="closeFullscreen"><svg class="icon-xl"><use href="#icon-x"></use></svg></button>

        <div class="area-info" id="areaInfo">
            <div class="area-info-label" data-i18n-app="areaLabel">√Årea Selecionada</div>
            <div class="area-info-value"><span id="areaValue">0</span> <span>ha</span></div>
            <div class="area-limit-text" data-i18n-app="areaLimit">Limite: 10.000 ha</div>
            <div class="area-coords" id="areaCoords"></div>
            <div class="area-coords" id="areaMeta"></div>
            <button class="btn-export" id="exportBtn" data-i18n-app="exportBtn"><svg class="icon-sm"><use href="#icon-download"></use></svg> Exportar GeoJSON</button>
        </div>

        <div class="map-legend">
            <div class="map-legend-title" data-i18n-app="legendTitle">Legenda</div>
            <div class="legend-row"><div class="legend-dot neutral"></div><span data-i18n-app="legendNeutral">√Årea Desenhada</span></div>
            <div class="legend-row"><div class="legend-dot approved"></div><span data-i18n-app="legendApproved">Aprovado</span></div>
            <div class="legend-row"><div class="legend-dot warning"></div><span data-i18n-app="legendWarning">Aten√ß√£o</span></div>
            <div class="legend-row"><div class="legend-dot rejected"></div><span data-i18n-app="legendRejected">Rejeitado</span></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <div class="card-title"><svg class="icon card-title-icon"><use href="#icon-key"></use></svg> <span data-i18n-app="authTitle">Autentica√ß√£o</span></div>
            <div class="input-wrapper">
                <input type="password" id="apiKey" data-i18n-app="apiKeyPlaceholder" placeholder="Cole sua API Key">
                <button class="input-eye" id="toggleKey"><svg class="icon"><use href="#icon-eye"></use></svg></button>
            </div>
            <button id="getApiKeyBtn" style="margin-top: 10px; width: 100%; padding: 10px; background: linear-gradient(135deg, var(--accent-green), #059669); color: white; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                üîë <span data-i18n-app="getApiKeyFree">Obter API Key Gr√°tis</span>
            </button>
            <p style="font-size: 0.65rem; color: var(--text-muted); margin-top: 6px; text-align: center;">
                3 valida√ß√µes gratuitas ‚Ä¢ Sem cart√£o de cr√©dito
            </p>
        </div>

        <div class="card">
            <div class="card-title"><svg class="icon card-title-icon"><use href="#icon-upload"></use></svg> <span data-i18n-app="uploadTitle">Upload de Arquivo</span></div>
            <label class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".json,.geojson">
                <div class="upload-icon"><svg class="icon-xl"><use href="#icon-file"></use></svg></div>
                <div class="upload-text" data-i18n-app="uploadText">Toque para selecionar</div>
                <div class="upload-hint" data-i18n-app="uploadHint">GeoJSON ou JSON</div>
            </label>
            <div class="upload-filename" id="fileName"></div>

            <button class="btn-export" id="testExampleBtn" style="margin-top: 10px; background: var(--accent-blue); color: white; border-color: var(--accent-blue);" data-i18n-app="sampleBtn">
                <svg class="icon-sm"><use href="#icon-target"></use></svg> Testar com √Årea de Exemplo
            </button>
        </div>

        <button class="btn-validate" id="validateBtn" disabled data-i18n-app="validateBtn"><svg class="icon"><use href="#icon-search"></use></svg> Validar √Årea</button>

        <!-- DATA FRESHNESS CARD -->
        <div id="dataFreshnessCard" class="card" style="display: none; margin-top: 1rem;">
            <div class="card-title">
                <svg class="icon card-title-icon"><use href="#icon-calendar"></use></svg>
                <span data-i18n-app="dataFreshness">Atualiza√ß√£o dos Dados</span>
            </div>
            <div id="dataFreshnessContent" style="font-size: 0.85rem; color: var(--text-muted); padding-top: 0.5rem;">
                <!-- Preenchido via JavaScript -->
            </div>
        </div>

        <div class="card result-card" id="resultCard">
            <div class="result-banner" id="resultBanner">
                <div class="result-icon" id="resultIcon">‚úì</div>
                <div>
                    <div class="result-title" id="resultTitle">Conforme</div>
                    <div class="result-subtitle" id="resultSubtitle">Conformidade: <span class="skeleton skeleton-text"></span>/100</div>
                </div>
            </div>
            <div class="compliance-section">
                <div class="compliance-label">Conformidade (0‚Äì100 ‚Ä¢ quanto maior, melhor)</div>
                <div class="compliance-bar"><div class="compliance-fill" id="complianceFill"></div></div>
                <div class="compliance-row">
                    <span><strong id="complianceValue"><span class="skeleton skeleton-text"></span></strong>/100</span>
                    <span id="complianceLabel"><span class="skeleton skeleton-text"></span></span>
                </div>
            </div>
            <div class="checks-list" id="checksList"></div>
            <div class="meta-row">
                <span id="metaTime">‚è±Ô∏è <span class="skeleton skeleton-text"></span>ms</span>
                <span id="metaDate">üìÖ <span class="skeleton skeleton-date"></span></span>
            </div>
            <button class="btn-pdf" id="pdfBtn" data-i18n-app="pdfBtn"><svg class="icon-sm"><use href="#icon-file"></use></svg> Baixar Relat√≥rio PDF</button>
        </div>

        <!-- HISTORY -->
        <div class="card">
            <div class="card-title">
                <span><svg class="icon card-title-icon"><use href="#icon-history"></use></svg> <span data-i18n-app="historyTitle">Hist√≥rico</span></span>
                <button class="btn-clear-history card-title-right" id="clearHistory" data-i18n-app="clearHistory">Limpar</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="history-empty">
                    Nenhuma valida√ß√£o ainda
                    <button class="history-empty-cta" onclick="document.getElementById('testExampleBtn').click()">
                        <svg class="icon-sm"><use href="#icon-target"></use></svg> Testar com √Årea de Exemplo
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer Trust Signals -->
        <div style="margin-top: 20px; padding: 16px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-muted); line-height: 1.6;">
                <svg class="icon-sm" style="color: var(--accent-green);"><use href="#icon-lock"></use></svg> <strong>Dados Criptografados</strong> ‚Ä¢ Fontes Oficiais Certificadas<br>
                <span style="font-size: 0.65rem; opacity: 0.8;">INPE ‚Ä¢ FUNAI ‚Ä¢ IBAMA ‚Ä¢ ICMBio ‚Ä¢ INCRA ‚Ä¢ MapBiomas</span>
            </div>
        </div>
    </div>
</div>

<div class="help-modal" id="helpModal">
    <div class="help-card">
        <button class="close-help" id="closeHelp"><svg class="icon"><use href="#icon-x"></use></svg></button>
        <div class="help-header">
            <div class="help-icon"><svg class="icon-xl" style="width: 3rem; height: 3rem;"><use href="#icon-help"></use></svg></div>
            <h2>Como usar o GreenGate</h2>
        </div>
        <div class="help-steps">
            <div class="step-item">
                <div class="step-number">1</div>
                <div class="step-content"><h4 data-i18n-app="step1Title">Navegue e Defina a √Årea</h4><p data-i18n-app="step1Text">Use a busca, desenhe com o <strong>L√°pis (‚úèÔ∏è)</strong>, fa√ßa upload ou teste com √°rea de exemplo. <span style="color:var(--accent-yellow); font-size:0.75rem;">Limite: 10.000 ha.</span></p></div>
            </div>
            <div class="step-item">
                <div class="step-number">2</div>
                <div class="step-content"><h4 data-i18n-app="step2Title">Valida√ß√£o Autom√°tica</h4><p data-i18n-app="step2Text">Clique em <strong>Validar √Årea</strong> para cruzamento instant√¢neo com 7 bases oficiais (PRODES, MapBiomas, TIs, Embargos, etc).</p></div>
            </div>
            <div class="step-item">
                <div class="step-number">3</div>
                <div class="step-content"><h4 data-i18n-app="step3Title">Relat√≥rio PDF</h4><p data-i18n-app="step3Text">Baixe o relat√≥rio profissional com mapas, verifica√ß√µes detalhadas e QR Code de autenticidade. <strong>Requer API Key</strong>.</p></div>
            </div>
        </div>
        <button class="btn-start" id="startBtn">Come√ßar a Usar</button>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" data-i18n-app="validatingArea">Validando √°rea...</div>
    <div class="loading-step" id="loadingStep" data-i18n-app="connecting">Conectando</div>
</div>

<div class="toast" id="toast"></div>

<!-- GDPR Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div class="cookie-consent-content">
        <div class="cookie-consent-text">
            <strong>üîí Privacy Notice:</strong> We use browser storage to save your API key locally (never sent to third parties).
            <a href="privacy-en.html" target="_blank">Privacy Policy</a> |
            <a href="terms-en.html" target="_blank">Terms of Use</a>
        </div>
        <div class="cookie-consent-buttons">
            <button class="cookie-consent-btn reject" onclick="rejectCookies()">Reject</button>
            <button class="cookie-consent-btn accept" onclick="acceptCookies()">Accept</button>
        </div>
    </div>
</div>

<!-- Modal Info Relat√≥rio -->
<div class="help-modal" id="pdfModal">
    <div class="help-card" style="max-width: 420px;">
        <button class="close-help" id="closePdfModal"><svg class="icon"><use href="#icon-x"></use></svg></button>
        <div class="help-header" style="margin-bottom: 20px;">
            <div class="help-icon"><svg class="icon-xl" style="width: 3rem; height: 3rem;"><use href="#icon-file"></use></svg></div>
            <h2 style="font-size: 1.2rem;" data-i18n-app="pdfModalTitle">Gerar Relat√≥rio PDF</h2>
        </div>
        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
            <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; margin-bottom: 16px; border-radius: 6px;">
                <p style="font-size: 0.75rem; color: #0c4a6e; margin: 0; line-height: 1.5;">
                    <strong>üí° Dica de Privacidade:</strong> Use identificadores internos (ex: "Fazenda #12345") ao inv√©s de nomes reais. Nomes de propriedades aparecem no relat√≥rio PDF mas s√£o redatados na verifica√ß√£o p√∫blica.
                </p>
            </div>

            <div>
                <label style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px;" data-i18n-app="pdfPropertyLabel">Nome da Propriedade (opcional)</label>
                <input type="text" id="farmName" data-i18n-app="pdfPropertyPlaceholder" placeholder="Ex: Farm #12345" style="width: 100%; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem;">
            </div>
            <div>
                <label style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px;" data-i18n-app="pdfPlotLabel">Nome do Talh√£o (opcional)</label>
                <input type="text" id="plotName" data-i18n-app="pdfPlotPlaceholder" placeholder="Ex: Plot A-12" style="width: 100%; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem;">
            </div>
            <div>
                <label style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px;" data-i18n-app="pdfLangLabel">Idioma do Relat√≥rio</label>
                <div style="display: flex; gap: 10px;">
                    <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="reportLang" value="pt" checked style="accent-color: var(--accent-green);">
                        <span data-i18n-app="pdfLangPt">Portugu√™s</span>
                    </label>
                    <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="reportLang" value="en" style="accent-color: var(--accent-green);">
                        <span data-i18n-app="pdfLangEn">English</span>
                    </label>
                </div>
            </div>
        </div>
        <p style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 15px; text-align: center;">
            üì± O relat√≥rio incluir√° QR Code para verifica√ß√£o de autenticidade
        </p>
        <button class="btn-start" id="confirmPdfBtn" data-i18n-app="confirmPdfBtn">üìÑ Gerar Relat√≥rio PDF</button>
    </div>
</div>

<!-- Modal Registro API Key -->
<div class="help-modal" id="registerModal">
    <div class="help-card" style="max-width: 380px;">
        <button class="close-help" id="closeRegisterModal"><svg class="icon"><use href="#icon-x"></use></svg></button>
        <div class="help-header" style="margin-bottom: 20px;">
            <div class="help-icon">üîë</div>
            <h2 style="font-size: 1.2rem;">Obter API Key Gr√°tis</h2>
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px;">Seu email</label>
            <input type="email" id="registerEmail" placeholder="seu@email.com" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: var(--bg-primary); color: var(--text-primary);">
        </div>
        <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 20px; font-size: 0.75rem; color: var(--text-muted);">
            ‚úÖ 3 valida√ß√µes gratuitas<br>
            ‚úÖ Sem cart√£o de cr√©dito<br>
            ‚úÖ API key instant√¢nea
        </div>
        <button class="btn-start" id="confirmRegisterBtn" style="width: 100%;">Criar Minha API Key</button>
        <p id="registerError" style="display: none; color: #ef4444; font-size: 0.75rem; margin-top: 10px; text-align: center;"></p>
        <p id="registerSuccess" style="display: none; color: var(--accent-green); font-size: 0.75rem; margin-top: 10px; text-align: center;"></p>
    </div>
</div>

<script src="https://js.arcgis.com/4.28/"></script>
<script>
    const API_URL = 'https://api.greengate.com.br';
    const MAX_HISTORY = 5;

    // ===================== SECURITY: API KEY STORAGE =====================
    // SECURITY NOTE: Browser storage is inherently insecure. API keys stored here
    // can be accessed via DevTools. This is acceptable for low-risk API keys.
    // For high-security scenarios, use server-side sessions with httpOnly cookies.

    // XOR encryption (kept for backward compatibility with existing stored keys)
    function simpleEncrypt(text) {
        const key = 'GG_' + navigator.userAgent.substring(0, 20);
        let encrypted = '';
        for (let i = 0; i < text.length; i++) {
            encrypted += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return btoa(encrypted);
    }

    function simpleDecrypt(encrypted) {
        try {
            const key = 'GG_' + navigator.userAgent.substring(0, 20);
            const decoded = atob(encrypted);
            let decrypted = '';
            for (let i = 0; i < decoded.length; i++) {
                decrypted += String.fromCharCode(decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            // Validate that result looks like an API key (alphanumeric)
            if (decrypted && /^[a-zA-Z0-9_-]+$/.test(decrypted)) {
                return decrypted;
            }
            return null;
        } catch (e) {
            return null;
        }
    }

    // ===================== GDPR COOKIE CONSENT =====================
    let cookieConsentGiven = localStorage.getItem('gg_cookie_consent') === 'true';

    function acceptCookies() {
        localStorage.setItem('gg_cookie_consent', 'true');
        cookieConsentGiven = true;
        document.getElementById('cookieConsent').classList.remove('show');
    }

    function rejectCookies() {
        localStorage.removeItem('gg_cookie_consent');
        localStorage.removeItem('gg_api_key_enc');
        localStorage.removeItem('gg_history');
        localStorage.removeItem('gg_tutorial');
        cookieConsentGiven = false;
        document.getElementById('cookieConsent').classList.remove('show');
        showToast('Data cleared. API key will not be saved.', 'info');
    }

    // Show consent banner if not decided
    window.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('gg_cookie_consent')) {
            setTimeout(() => {
                document.getElementById('cookieConsent').classList.add('show');
            }, 2000); // Show after 2 seconds
        }
    });

    // ===================== RATE LIMITING =====================
    let lastValidationTime = 0;
    const VALIDATION_COOLDOWN = 2000; // 2 seconds between validations

    let map, view, graphicsLayer, sketchVM, currentPolygon = null, currentGraphic = null, geoEngine, webMercatorUtils;
    let searchTimeout = null;

    // Camada de overlaps (geometrias de interse√ß√£o) e resultado da valida√ß√£o
    let overlapsLayer = null;
    let currentValidationResult = null;

    // meta da √°rea (para PDF / UI)
    let currentMeta = { municipality: null, state: null, address: null };

    // ===================== HELPERS =====================
    function clampConf(x) {
        const n = Number(x);
        if (!Number.isFinite(n)) return 0;
        return Math.max(0, Math.min(100, n));
    }

    function confLabel(conf) {
        if (conf >= 90) return 'Excelente';
        if (conf >= 70) return 'Bom';
        if (conf >= 40) return 'Regular';
        return 'Cr√≠tico';
    }

    // XSS Protection: escape HTML special characters
    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function fmtCheckType(c) {
        const map = {
            deforestation_prodes: 'Desmatamento PRODES',
            deforestation_mapbiomas: 'Alertas MapBiomas',
            terra_indigena: 'Terras Ind√≠genas',
            embargo_ibama: 'Embargos IBAMA',
            quilombola: 'Quilombolas',
            uc: 'Unidades de Conserva√ß√£o'
            // app_water removido - ser√° reimplementado com dados oficiais MT
        };
        return map[c] || escapeHtml(c);
    }

    function fmtCheckStatusBadge(s) {
        const map = {
            pass: 'Conforme',
            fail: 'N√£o conforme',
            warning: 'Aten√ß√£o',
            skip: 'N/A'
        };
        return map[s] || escapeHtml(s);
    }

    function fmtHistoryStatusLabel(s) {
        const map = { approved: 'OK', rejected: 'FAIL' };
        return map[s] || 'WARN';
    }

    function showToast(m, t = 'error') {
        const el = document.getElementById('toast');
        let message = typeof m === 'object' ? (m.detail || m.message || 'Erro') : m;

        // XSS Protection: Only allow safe HTML (links from our own code)
        // If message contains <a href with our email link, allow it
        // Otherwise, escape HTML
        const isSafeHTML = message.includes('mailto:greengatebrasil@gmail.com') || message.includes('href="#');

        if (isSafeHTML) {
            el.innerHTML = message; // Safe links from our code
        } else {
            // Escape HTML to prevent XSS
            const div = document.createElement('div');
            div.textContent = message;
            el.textContent = div.textContent;
        }

        el.className = 'toast ' + t;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), t === 'error' ? 5000 : 4000); // Errors show longer
    }

    function setValidateAvailability() {
        const ai = document.getElementById('areaInfo');
        const overLimit = ai.classList.contains('limit-exceeded');
        document.getElementById('validateBtn').disabled = !(currentPolygon && !overLimit);
    }

    // ===================== HISTORY =====================
    function getHistory() {
        try { return JSON.parse(localStorage.getItem('gg_history') || '[]'); }
        catch { return []; }
    }

    function saveHistory(result, area) {
        const conf = clampConf(result.risk_score);
        const h = getHistory();
        h.unshift({
            id: Date.now(),
            status: result.status,
            score: conf,
            area: area,
            date: new Date().toISOString(),
            polygon: currentPolygon,
            meta: currentMeta
        });
        if (h.length > MAX_HISTORY) h.pop();
        localStorage.setItem('gg_history', JSON.stringify(h));
        renderHistory();
    }

    function renderHistory() {
        const el = document.getElementById('historyList');
        const h = getHistory();
        el.textContent = ''; // Clear safely

        if (!h.length) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'history-empty';
            emptyDiv.appendChild(document.createTextNode(
                window.getAppTranslation ? window.getAppTranslation('historyEmpty') : 'Nenhuma valida√ß√£o ainda'
            ));

            const ctaBtn = document.createElement('button');
            ctaBtn.className = 'history-empty-cta';
            ctaBtn.onclick = () => document.getElementById('testExampleBtn').click();

            const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            iconSvg.setAttribute('class', 'icon-sm');
            const useEl = document.createElementNS('http://www.w3.org/2000/svg', 'use');
            useEl.setAttribute('href', '#icon-target');
            iconSvg.appendChild(useEl);
            ctaBtn.appendChild(iconSvg);
            ctaBtn.appendChild(document.createTextNode(' ' + (window.getAppTranslation ? window.getAppTranslation('sampleBtn') : 'Testar com √Årea de Exemplo')));

            emptyDiv.appendChild(ctaBtn);
            el.appendChild(emptyDiv);
            return;
        }

        const locale = window.getCurrentAppLang ? (window.getCurrentAppLang() === 'en' ? 'en-US' : 'pt-BR') : 'pt-BR';
        const complianceText = window.getAppTranslation ? window.getAppTranslation('compliance') : 'Conformidade:';

        h.forEach(i => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.dataset.id = i.id;

            const header = document.createElement('div');
            header.className = 'history-header';

            const statusSpan = document.createElement('span');
            statusSpan.className = 'history-status ' + (i.status || '');
            statusSpan.textContent = fmtHistoryStatusLabel(i.status);

            const dateSpan = document.createElement('span');
            dateSpan.className = 'history-date';
            dateSpan.textContent = new Date(i.date).toLocaleDateString(locale);

            header.appendChild(statusSpan);
            header.appendChild(dateSpan);

            const info = document.createElement('div');
            info.className = 'history-info';
            const area = Number(i.area) || 0;
            const score = Number(i.score) || 0;
            info.textContent = area.toFixed(1) + ' ha ‚Ä¢ ' + complianceText + ' ' + score + '/100';

            item.appendChild(header);
            item.appendChild(info);

            item.onclick = () => {
                const found = h.find(x => x.id === +item.dataset.id);
                if (found?.polygon) {
                    currentMeta = found.meta || { municipality: null, state: null, address: null };
                    loadGeoJSON(found.polygon);
                    showToast(window.getAppTranslation ? window.getAppTranslation('polygonLoaded') : 'Pol√≠gono carregado', 'success');
                }
            };

            el.appendChild(item);
        });
    }

    // ===================== CLEAR =====================
    function clearAll() {
        if (sketchVM) sketchVM.cancel();
        currentPolygon = null; currentGraphic = null;
        currentMeta = { municipality: null, state: null, address: null };
        currentValidationResult = null;

        if (graphicsLayer) graphicsLayer.removeAll();
        if (overlapsLayer) overlapsLayer.removeAll();

        const ai = document.getElementById('areaInfo');
        ai.classList.remove('show', 'limit-exceeded');

        document.getElementById('areaValue').textContent = '0';
        document.getElementById('areaCoords').textContent = '';
        document.getElementById('areaMeta').textContent = '';

        document.getElementById('resultCard').classList.remove('show');
        document.getElementById('uploadArea').classList.remove('has-file');
        document.getElementById('fileName').classList.remove('show');
        document.getElementById('fileInput').value = '';
        document.getElementById('drawBtn').classList.remove('active');
        document.getElementById('drawOptions').classList.remove('show');

        setValidateAvailability();
    }

    // ===================== INIT =====================
    document.addEventListener('DOMContentLoaded', () => {
        // Load encrypted API key if consent given
        if (cookieConsentGiven) {
            const encryptedKey = localStorage.getItem('gg_api_key_enc');
            if (encryptedKey) {
                const decrypted = simpleDecrypt(encryptedKey);
                if (decrypted) document.getElementById('apiKey').value = decrypted;
            }
        }
        renderHistory();
        // Auto-open tutorial removed - user clicks "?" button instead
    });

    // ===================== ESRI =====================
    require([
        "esri/Map", "esri/views/MapView", "esri/layers/GraphicsLayer",
        "esri/widgets/Sketch/SketchViewModel", "esri/Graphic",
        "esri/geometry/geometryEngine", "esri/geometry/Polygon",
        "esri/widgets/BasemapGallery", "esri/widgets/Expand",
        "esri/geometry/support/webMercatorUtils", "esri/rest/locator"
    ], function(Map, MapView, GraphicsLayer, SketchVM, Graphic, geoEng, Polygon, BasemapGallery, Expand, wmUtils, locator) {

        geoEngine = geoEng; webMercatorUtils = wmUtils;

        map = new Map({ basemap: "hybrid" });
        view = new MapView({
            container: "map",
            map,
            center: [-55.5, -12.5],
            zoom: 6,
            ui: { padding: { bottom: 200 } }
        });

        view.ui.move("zoom", "bottom-right");
        view.ui.add(new Expand({
            view,
            content: new BasemapGallery({ view }),
            expandIconClass: "esri-icon-basemap",
            autoCollapse: true
        }), "top-right");

        graphicsLayer = new GraphicsLayer();
        map.add(graphicsLayer);

        // Camada separada para desenhar os overlaps (geometrias de interse√ß√£o)
        overlapsLayer = new GraphicsLayer();
        map.add(overlapsLayer);

        sketchVM = new SketchVM({
            view,
            layer: graphicsLayer,
            polygonSymbol: {
                type: "simple-fill",
                color: [59,130,246,0.3],
                outline: { color: [59,130,246], width: 2 }
            }
        });

        // ========= flash polygon (feedback visual ao clicar checks) =========
        window.flashCurrentGraphic = () => {
            if (!currentGraphic) return;
            const original = currentGraphic.symbol;
            const outline = (original && original.outline) ? original.outline : { color: [255,255,255,1], width: 2 };
            currentGraphic.symbol = {
                type: "simple-fill",
                color: original?.color || [59,130,246,0.3],
                outline: { color: outline.color, width: 5 }
            };
            setTimeout(() => { if (currentGraphic) currentGraphic.symbol = original; }, 250);
        };

        // ========== SEARCH ==========
        const GEOCODE = "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer";
        const sInput = document.getElementById('searchInput');
        const sResults = document.getElementById('searchResults');
        const sClear = document.getElementById('searchClear');

        let lastSearchResults = [];

        // Helper: create search status message safely
        function setSearchStatus(container, className, message) {
            container.textContent = '';
            const div = document.createElement('div');
            div.className = className;
            div.textContent = message;
            container.appendChild(div);
        }

        sInput.oninput = (e) => {
            const q = e.target.value.trim();
            sClear.classList.toggle('show', q.length > 0);
            if (searchTimeout) clearTimeout(searchTimeout);
            if (q.length < 2) { sResults.classList.remove('show'); return; }

            setSearchStatus(sResults, 'search-loading', window.getAppTranslation ? window.getAppTranslation('searching') : 'Buscando...');
            sResults.classList.add('show');

            searchTimeout = setTimeout(() => {
                locator.addressToLocations(GEOCODE, {
                    address: { SingleLine: q + ", Brasil" },
                    countryCode: "BRA",
                    maxLocations: 5,
                    outFields: ["Addr_type", "City", "Region"]
                }).then(res => {
                    lastSearchResults = res || [];
                    if (!res.length) {
                        setSearchStatus(sResults, 'search-empty', window.getAppTranslation ? window.getAppTranslation('noResults') : 'Nenhum resultado');
                        return;
                    }

                    sResults.textContent = '';
                    res.forEach((r, i) => {
                        const item = document.createElement('div');
                        item.className = 'search-item';
                        item.dataset.i = i;

                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'search-item-name';
                        nameDiv.textContent = r.address || '';

                        const typeDiv = document.createElement('div');
                        typeDiv.className = 'search-item-type';
                        typeDiv.textContent = (r.attributes && r.attributes.Addr_type) || 'Local';

                        item.appendChild(nameDiv);
                        item.appendChild(typeDiv);

                        item.onclick = () => {
                            view.goTo({
                                center: [r.location.longitude, r.location.latitude],
                                zoom: r.attributes.Addr_type === 'Locality' ? 12 : 8
                            });
                            sInput.value = r.address;
                            sResults.classList.remove('show');
                        };

                        sResults.appendChild(item);
                    });
                }).catch(() => setSearchStatus(sResults, 'search-empty', window.getAppTranslation ? window.getAppTranslation('searchError') : 'Erro na busca'));
            }, 350);
        };

        sInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && lastSearchResults.length) {
                const r = lastSearchResults[0];
                view.goTo({
                    center: [r.location.longitude, r.location.latitude],
                    zoom: r.attributes.Addr_type === 'Locality' ? 12 : 8
                });
                sInput.value = r.address;
                sResults.classList.remove('show');
            }
        });

        sClear.onclick = () => {
            sInput.value = '';
            sClear.classList.remove('show');
            sResults.classList.remove('show');
        };

        document.addEventListener('click', e => {
            if (!e.target.closest('.search-box')) sResults.classList.remove('show');
        });

        // ========== reverse geocode ==========
        async function fillMetaFromGeometry(geo) {
            try {
                if (!geo?.centroid) return;
                let c = geo.centroid;
                if (c.spatialReference?.isWebMercator) c = webMercatorUtils.webMercatorToGeographic(c);

                const resp = await locator.locationToAddress(GEOCODE, {
                    location: c,
                    outFields: ["City", "Region", "Subregion", "Neighborhood"],
                    langCode: "pt"
                });

                const attrs = resp?.attributes || {};
                const municipality = attrs.City || null;
                const state = attrs.Region || null;

                currentMeta = {
                    municipality,
                    state,
                    address: resp?.address || null
                };

                const metaEl = document.getElementById('areaMeta');
                const parts = [];
                if (municipality) parts.push(municipality);
                if (state) parts.push(state);
                metaEl.textContent = parts.length ? parts.join(' ‚Ä¢ ') : '';
            } catch (_) {
                // silencioso
            }
        }

        // ========== AREA ==========
        const checkArea = (geo) => {
            if (!geo) return false;
            const area = Math.abs(geoEngine.geodesicArea(geo, "square-meters")) / 10000;
            const c = geo.centroid;
            const ai = document.getElementById('areaInfo');

            document.getElementById('areaValue').textContent = area.toFixed(2);
            document.getElementById('areaCoords').textContent = c ? `${c.latitude.toFixed(5)}, ${c.longitude.toFixed(5)}` : '';
            ai.classList.add('show');

            if (area > 10000) {
                ai.classList.add('limit-exceeded');
                setValidateAvailability();
                return false;
            }
            ai.classList.remove('limit-exceeded');
            setValidateAvailability();
            return true;
        };

        sketchVM.on(["create", "update"], e => {
            if (e.state === "active") checkArea(e.graphic.geometry);

            if (e.state === "complete") {
                currentGraphic = e.graphic;

                let geo = e.graphic.geometry;
                if (geo.spatialReference?.isWebMercator) geo = webMercatorUtils.webMercatorToGeographic(geo);

                const simp = geoEngine.simplify(geo) || geo;
                currentPolygon = { type: "Polygon", coordinates: simp.rings };

                document.getElementById('drawOptions').classList.remove('show');
                document.getElementById('drawBtn').classList.remove('active');

                const ok = checkArea(simp);
                if (ok) fillMetaFromGeometry(simp);
            }
        });

        window.loadGeoJSON = (geom) => {
            clearAll();
            isExampleArea = false; // Resetar flag (√°rea de exemplo vai setar novamente)
            const poly = new Polygon({ rings: geom.coordinates, spatialReference: { wkid: 4326 } });
            const g = new Graphic({
                geometry: poly,
                symbol: { type: "simple-fill", color: [59,130,246,0.3], outline: { color: [59,130,246], width: 2 } }
            });

            graphicsLayer.add(g);
            currentGraphic = g;
            view.goTo(g.geometry.extent.expand(1.5));

            currentPolygon = geom;

            const ok = checkArea(poly);
            if (ok) fillMetaFromGeometry(poly);
        };

        window.updateColor = (s) => {
            if (!currentGraphic) return;
            const c = {
                approved: [[16,185,129,0.3],[16,185,129]],
                rejected: [[239,68,68,0.3],[239,68,68]],
                warning: [[245,158,11,0.3],[245,158,11]]
            }[s] || [[59,130,246,0.3],[59,130,246]];

            currentGraphic.symbol = { type: "simple-fill", color: c[0], outline: { color: c[1], width: 2 } };
        };

        // ========== BUTTONS ==========
        document.getElementById('drawBtn').onclick = e => {
            e.preventDefault();
            if (sketchVM.state === "active") sketchVM.cancel();
            document.getElementById('drawOptions').classList.toggle('show');
            document.getElementById('drawBtn').classList.toggle('active');
        };

        document.getElementById('drawPolygon').onclick = e => {
            e.preventDefault();
            clearAll();
            isExampleArea = false; // N√£o √© mais √°rea de exemplo
            sketchVM.create("polygon");
            document.getElementById('drawOptions').classList.remove('show');
        };

        document.getElementById('drawRect').onclick = e => {
            e.preventDefault();
            clearAll();
            isExampleArea = false; // N√£o √© mais √°rea de exemplo
            sketchVM.create("rectangle");
            document.getElementById('drawOptions').classList.remove('show');
        };

        document.getElementById('clearBtn').onclick = e => { e.preventDefault(); clearAll(); };

        document.getElementById('locateBtn').onclick = e => {
            e.preventDefault();
            navigator.geolocation?.getCurrentPosition(p => view.goTo({ center: [p.coords.longitude, p.coords.latitude], zoom: 14 }));
        };

        document.getElementById('fullscreenBtn').onclick = e => {
            e.preventDefault();
            document.body.classList.add('fullscreen-mode');
            setTimeout(() => view.requestResize(), 100);
        };

        document.getElementById('closeFullscreen').onclick = e => {
            e.preventDefault();
            document.body.classList.remove('fullscreen-mode');
            view.requestResize();
        };
    });

    // ===================== EXPORT GEOJSON =====================
    document.getElementById('exportBtn').onclick = () => {
        if (!currentPolygon) { showToast(window.getAppTranslation ? window.getAppTranslation('noPolygon') : 'Nenhum pol√≠gono'); return; }
        const gj = { type: "Feature", properties: { source: "GreenGate", exported: new Date().toISOString() }, geometry: currentPolygon };
        const blob = new Blob([JSON.stringify(gj, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `area-${Date.now()}.geojson`; a.click();
        showToast(window.getAppTranslation ? window.getAppTranslation('geojsonExported') : 'GeoJSON exportado!', 'success');
    };

    // ===================== UI =====================
    const modal = document.getElementById('helpModal');
    const toggleModal = s => { s ? modal.classList.add('show') : (modal.classList.remove('show'), localStorage.setItem('gg_tutorial', '1')); };
    document.getElementById('helpBtn').onclick = () => toggleModal(true);
    document.getElementById('closeHelp').onclick = () => toggleModal(false);
    document.getElementById('startBtn').onclick = () => toggleModal(false);

    document.getElementById('clearHistory').onclick = () => {
        if (confirm(window.getAppTranslation ? window.getAppTranslation('clearHistoryConfirm') : 'Limpar hist√≥rico?')) { localStorage.removeItem('gg_history'); renderHistory(); }
    };

    document.getElementById('toggleKey').onclick = e => {
        e.preventDefault();
        const i = document.getElementById('apiKey');
        i.type = i.type === 'password' ? 'text' : 'password';
        e.target.textContent = i.type === 'password' ? 'üëÅÔ∏è' : 'üîí';
    };

    document.getElementById('fileInput').onchange = e => {
        const f = e.target.files[0]; if (!f) return;
        document.getElementById('fileName').textContent = f.name;
        document.getElementById('fileName').classList.add('show');
        document.getElementById('uploadArea').classList.add('has-file');

        const r = new FileReader();
        r.onload = ev => {
            try {
                const j = JSON.parse(ev.target.result);
                loadGeoJSON(j.type === 'FeatureCollection' ? j.features[0].geometry : j.type === 'Feature' ? j.geometry : j);
            } catch (err) { showToast((window.getAppTranslation ? window.getAppTranslation('errorUpload') : 'Erro: ') + err.message); }
        };
        r.readAsText(f);
    };

    // Flag global para √°rea de exemplo (permite valida√ß√£o sem API Key)
    let isExampleArea = false;

    // ===================== TESTE COM EXEMPLO =====================
    document.getElementById('testExampleBtn').onclick = () => {
        // √Årea de exemplo: real de valida√ß√£o no Mato Grosso (regi√£o de Sinop)
        const exampleGeometry = {
            type: "Polygon",
            coordinates: [[
                [-55.3594394984761, -11.86920257487204],
                [-55.35394633441345, -11.871806426068545],
                [-55.36038363604937, -11.884783313415083],
                [-55.36201441913047, -11.88398539967109],
                [-55.363430625490366, -11.883565444129728],
                [-55.36549056201385, -11.883271474865357],
                [-55.3594394984761, -11.86920257487204]
            ]]
        };

        loadGeoJSON(exampleGeometry);
        isExampleArea = true; // Marcar como √°rea de exemplo
        document.getElementById('fileName').textContent = window.getAppTranslation ? window.getAppTranslation('areaFileName') : 'üìç √Årea de Exemplo (Sinop, MT) - Valida√ß√£o livre';
        document.getElementById('fileName').classList.add('show');
        document.getElementById('uploadArea').classList.add('has-file');
        showToast(window.getAppTranslation ? window.getAppTranslation('sampleLoaded') : '‚ú® √Årea de exemplo carregada! Clique em "Validar √Årea" para testar sem API Key.', 'success');
    };

    // ===================== VALIDATE =====================
    async function validate() {
        // Rate limiting check
        const now = Date.now();
        if (now - lastValidationTime < VALIDATION_COOLDOWN) {
            showToast('‚è±Ô∏è Please wait ' + Math.ceil((VALIDATION_COOLDOWN - (now - lastValidationTime)) / 1000) + ' seconds between validations', 'error');
            return;
        }

        const key = document.getElementById('apiKey').value.trim();

        // Permitir valida√ß√£o sem chave APENAS para √°rea de exemplo
        if (!key && !isExampleArea) {
            showToast('‚ö†Ô∏è API Key necess√°ria. <a href="#" onclick="openRegisterModal(); return false;" style="color: white; text-decoration: underline; font-weight: bold;">Obter API Key Gr√°tis ‚Üí</a>', 'error');
            return;
        }

        if (!currentPolygon) { showToast(window.getAppTranslation ? window.getAppTranslation('noPolygon') : 'Nenhum pol√≠gono'); return; }

        // Informar se est√° validando √°rea de exemplo sem chave
        if (isExampleArea && !key) {
            showToast('üéØ Validando √°rea de exemplo (sem API Key). Para suas √°reas reais, obtenha uma chave.', 'info');
        }

        // Save encrypted API key if consent given
        if (cookieConsentGiven && key) {
            const encrypted = simpleEncrypt(key);
            localStorage.setItem('gg_api_key_enc', encrypted);
        }

        lastValidationTime = now; // Update rate limit timestamp

        document.getElementById('loadingOverlay').classList.add('show');
        document.getElementById('validateBtn').disabled = true;

        const steps = ['Analisando PRODES...', 'Verificando MapBiomas...', 'Consultando TIs...', 'Verificando Embargos...', 'Analisando UCs...', 'Processando...'];
        let i = 0;
        const iv = setInterval(() => { if (i < steps.length) document.getElementById('loadingStep').textContent = steps[i++]; }, 2000);

        try {
            const headers = { 'Content-Type': 'application/json' };
            if (key) headers['x-api-key'] = key;

            const res = await fetch(API_URL + '/api/v1/validations/quick', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(currentPolygon)
            });

            clearInterval(iv);
            const data = await res.json();

            // Sanitized error handling (don't expose backend details)
            // Use translations for error messages
            const t = (key) => window.getAppTranslation ? window.getAppTranslation(key) : key;

            if (res.status === 429) {
                const emailLink = 'mailto:greengatebrasil@gmail.com?subject=Aumentar Cota Mensal GreenGate';
                throw new Error(t('error_quota_exceeded') + ' <a href="' + emailLink + '">' + t('error_quota_contact') + '</a>');
            }

            if (res.status === 401 || res.status === 403) {
                const emailLink = 'mailto:greengatebrasil@gmail.com?subject=Problema com API Key GreenGate';
                throw new Error(t('error_invalid_key') + ' <a href="' + emailLink + '">' + t('error_quota_contact') + '</a>');
            }

            if (res.status === 400) {
                throw new Error(t('error_invalid_geometry'));
            }

            if (res.status >= 500) {
                throw new Error(t('error_server'));
                // Log details to console for debugging (not shown to user)
                console.error('Backend error:', data);
            }

            if (!res.ok) {
                // Generic error (don't expose backend details to user)
                throw new Error(t('error_generic'));
            }

            saveHistory(data, parseFloat(document.getElementById('areaValue').textContent));
            showResult(data);

        } catch (err) {
            clearInterval(iv);

            // Sanitized error messages (don't expose technical details)
            let errorMessage = err.message;

            // Network errors (generic message)
            if (errorMessage.includes('fetch') || errorMessage.includes('Failed') || errorMessage.includes('NetworkError') || errorMessage.includes('TypeError')) {
                const t = (key) => window.getAppTranslation ? window.getAppTranslation(key) : key;
                errorMessage = t('error_connection');
                console.error('Network error details:', err); // Log for debugging
            }

            showToast(errorMessage);

        } finally {
            document.getElementById('loadingOverlay').classList.remove('show');
            setValidateAvailability(); // N√ÉO reabilitar se estiver acima do limite
        }
    }

    function displayDataFreshness(dataFreshness) {
        if (!dataFreshness || Object.keys(dataFreshness).length === 0) {
            document.getElementById('dataFreshnessCard').style.display = 'none';
            return;
        }

        const card = document.getElementById('dataFreshnessCard');
        const content = document.getElementById('dataFreshnessContent');

        const layerNames = {
            'prodes': 'PRODES (Desmatamento)',
            'embargo_ibama': 'Embargos IBAMA',
            'terra_indigena': 'Terras Ind√≠genas',
            'uc': 'Unidades de Conserva√ß√£o',
            'quilombola': 'Territ√≥rios Quilombolas',
            'mapbiomas': 'MapBiomas'
        };

        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">';

        for (const [layer, date] of Object.entries(dataFreshness)) {
            const layerDate = new Date(date);
            const formattedDate = layerDate.toLocaleDateString('pt-BR');
            // Escape layer name if not in known list
            const layerName = layerNames[layer] || escapeHtml(layer);

            // Calcular h√° quantos dias foi atualizado
            const daysSince = Math.floor((Date.now() - layerDate.getTime()) / (1000 * 60 * 60 * 24));
            let freshnessColor = '#059669'; // Verde
            if (daysSince > 30) freshnessColor = '#d97706'; // Laranja
            if (daysSince > 90) freshnessColor = '#dc2626'; // Vermelho

            html += `
                <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px; border-left: 3px solid ${freshnessColor};">
                    <strong style="font-size: 0.75rem; color: var(--text-muted); display: block;">${layerName}</strong>
                    <span style="font-size: 0.9rem; color: var(--text-primary);">${formattedDate}</span>
                    ${daysSince === 0 ? '<span style="font-size: 0.7rem; color: #059669; display: block;">‚Ä¢ Hoje</span>' :
                      daysSince === 1 ? '<span style="font-size: 0.7rem; color: #059669; display: block;">‚Ä¢ Ontem</span>' :
                      daysSince < 7 ? `<span style="font-size: 0.7rem; color: #059669; display: block;">‚Ä¢ ${daysSince} dias atr√°s</span>` :
                      daysSince < 30 ? `<span style="font-size: 0.7rem; color: #059669; display: block;">‚Ä¢ ${Math.floor(daysSince/7)} semanas atr√°s</span>` :
                      `<span style="font-size: 0.7rem; color: ${freshnessColor}; display: block;">‚Ä¢ ${Math.floor(daysSince/30)} meses atr√°s</span>`}
                </div>
            `;
        }

        html += '</div>';

        content.innerHTML = html;
        card.style.display = 'block';
    }

    function showResult(d) {
        // Armazenar resultado para uso posterior (ex: destacar overlaps no mapa)
        currentValidationResult = d;

        // Limpar overlaps anteriores
        if (overlapsLayer) {
            overlapsLayer.removeAll();
        }

        // Exibir datas de atualiza√ß√£o dos dados (se dispon√≠vel)
        if (d.data_freshness) {
            displayDataFreshness(d.data_freshness);
        }

        document.getElementById('resultCard').classList.add('show');
        document.getElementById('resultBanner').className = 'result-banner ' + d.status;

        const resultIconEl = document.getElementById('resultIcon');
        if (d.status === 'approved') {
            resultIconEl.innerHTML = '<svg class="icon-xl"><use href="#icon-check"></use></svg>';
        } else if (d.status === 'rejected') {
            resultIconEl.innerHTML = '<svg class="icon-xl"><use href="#icon-x"></use></svg>';
        } else {
            resultIconEl.innerHTML = '<svg class="icon-xl"><use href="#icon-warning"></use></svg>';
        }
        document.getElementById('resultTitle').textContent = d.status === 'approved' ? 'Conforme' : d.status === 'rejected' ? 'N√£o Conforme' : 'Aten√ß√£o';

        const conf = clampConf(d.risk_score);
        const label = confLabel(conf);

        document.getElementById('resultSubtitle').textContent = `Conformidade: ${conf}/100 ‚Ä¢ ${label}`;

        const fill = document.getElementById('complianceFill');
        fill.style.width = conf + '%';
        fill.className = 'compliance-fill ' + (conf >= 70 ? 'high' : conf >= 40 ? 'medium' : 'low');

        document.getElementById('complianceValue').textContent = conf;
        document.getElementById('complianceLabel').textContent = label;

        const list = document.getElementById('checksList');
        list.innerHTML = '';

        (d.checks || []).forEach(c => {
            let iconSvg = '<svg class="icon"><use href="#icon-check"></use></svg>';
            if (c.status === 'fail') iconSvg = '<svg class="icon"><use href="#icon-x"></use></svg>';
            else if (c.status === 'warning') iconSvg = '<svg class="icon"><use href="#icon-warning"></use></svg>';
            else if (c.status === 'skip') iconSvg = '<span style="opacity: 0.5;">‚Äî</span>';

            // Mapear fontes oficiais por tipo de check
            // Os check_types v√™m da API: deforestation_prodes, terra_indigena, etc.
            const checkMetadata = {
                // PRODES
                'deforestation_prodes': { source: 'PRODES/INPE', id_field: null },
                'deforestation': { source: 'PRODES/INPE', id_field: null },
                'prodes': { source: 'PRODES/INPE', id_field: null },
                // MapBiomas
                'deforestation_mapbiomas': { source: 'MapBiomas', id_field: 'alertCode' },
                'mapbiomas': { source: 'MapBiomas', id_field: 'alertCode' },
                'mapbiomas_alert': { source: 'MapBiomas', id_field: 'alertCode' },
                // Terras Ind√≠genas
                'terra_indigena': { source: 'FUNAI', id_field: 'terrai_cod' },
                'indigenous_territory': { source: 'FUNAI', id_field: 'terrai_cod' },
                // Unidades de Conserva√ß√£o
                'uc': { source: 'ICMBio/MMA', id_field: 'cnuc_cod' },
                'conservation_unit': { source: 'ICMBio/MMA', id_field: 'cnuc_cod' },
                // Embargos IBAMA
                'embargo_ibama': { source: 'IBAMA', id_field: 'num_auto_infracao' },
                'embargo': { source: 'IBAMA', id_field: 'num_auto_infracao' },
                // Quilombolas
                'quilombola': { source: 'INCRA', id_field: 'sipra_cod' },
                'settlement': { source: 'INCRA', id_field: 'sipra_cod' }
            };

            const meta = checkMetadata[c.check_type] || { source: 'Base oficial', id_field: null };

            // Usar last_updated da API se dispon√≠vel, caso contr√°rio mostrar --
            const updated = c.last_updated || null;

            // Calcular "h√° X dias" para mostrar frescor dos dados
            function daysAgo(dateStr) {
                if (!dateStr || dateStr === '--') return '';
                const updated = new Date(dateStr);
                const now = new Date();
                const diffTime = Math.abs(now - updated);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays === 0) return ' (hoje)';
                if (diffDays === 1) return ' (ontem)';
                if (diffDays < 30) return ` (h√° ${diffDays} dias)`;
                const months = Math.floor(diffDays / 30);
                return ` (h√° ${months} ${months === 1 ? 'm√™s' : 'meses'})`;
            }

            let det = '<p>' + escapeHtml(c.message || '') + '</p>';

            // √Årea afetada
            if ((c.overlap_area_ha || 0) > 0) {
                const area = Number(c.overlap_area_ha);
                const pct = Number(c.overlap_percentage || 0);

                // Mostrar √°rea com precis√£o adequada ao valor
                let areaText;
                if (area >= 1) {
                    areaText = area.toFixed(2) + ' ha';
                } else if (area >= 0.01) {
                    areaText = area.toFixed(2) + ' ha';
                } else if (area >= 0.0001) {
                    areaText = area.toFixed(4) + ' ha';
                } else {
                    areaText = '< 0.0001 ha';
                }

                // Mostrar porcentagem com precis√£o adequada ao valor
                let pctText;
                if (pct >= 1) {
                    pctText = pct.toFixed(1) + '%';
                } else if (pct >= 0.01) {
                    pctText = pct.toFixed(2) + '%';
                } else if (pct > 0) {
                    pctText = '< 0.01%';
                } else {
                    pctText = '0%';
                }
                det += '<div class="check-overlap-box"><strong>üìç √Årea Afetada:</strong> ' +
                    areaText + ' (' + pctText + ' da √°rea total)</div>';
            }

            // Fonte e data de atualiza√ß√£o com badge de frescor
            det += '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-muted);">';
            det += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>üìã <strong>Fonte:</strong> ' + meta.source + '</span></div>';
            const freshnessText = updated ? new Date(updated).toLocaleDateString('pt-BR') + '<span style="color: var(--accent-green); font-weight: 600;">' + daysAgo(updated) + '</span>' : '--';
            det += '<div style="display: flex; justify-content: space-between;"><span>üìÖ <strong>Atualizado:</strong> ' + freshnessText + '</span></div>';

            // IDs oficiais (se dispon√≠veis no response)
            if (meta.id_field && c[meta.id_field]) {
                det += '<div style="margin-top: 4px;"><span>üÜî <strong>ID Oficial:</strong> ' + escapeHtml(c[meta.id_field]) + '</span></div>';
            }

            det += '</div>';

            // Bot√£o "Destacar no Mapa" (apenas se houver sobreposi√ß√£o)
            if ((c.overlap_area_ha || 0) > 0) {
                // Validate check_type against known types to prevent injection
                const safeCheckType = checkMetadata[c.check_type] ? c.check_type : 'unknown';
                det += '<button class="btn-highlight-map" style="margin-top: 12px; width: 100%; padding: 8px; background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent-green); border-radius: 6px; color: var(--accent-green); font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;" onclick="highlightOnMap(\'' + safeCheckType + '\', event)">üó∫Ô∏è Destacar no Mapa</button>';
            }

            // Validate status to prevent className injection
            const validStatuses = ['pass', 'fail', 'warning', 'skip'];
            const safeStatus = validStatuses.includes(c.status) ? c.status : 'skip';

            const row = document.createElement('div');
            row.className = 'check-row ' + safeStatus;

            row.innerHTML =
                `<div class="check-header" onclick="this.parentElement.classList.toggle('open'); window.flashCurrentGraphic && window.flashCurrentGraphic();">
                    <div class="check-left">
                        <div class="check-status-icon ${safeStatus}">${iconSvg}</div>
                        <span class="check-name">${fmtCheckType(c.check_type)}</span>
                    </div>
                    <div class="check-right">
                        <span class="check-badge ${safeStatus}">${fmtCheckStatusBadge(c.status)}</span>
                        <span class="check-arrow">‚ñº</span>
                    </div>
                </div>
                <div class="check-details">${det}</div>`;

            list.appendChild(row);
        });

        document.getElementById('metaTime').textContent = '‚è±Ô∏è ' + (d.processing_time_ms ?? '--') + 'ms';
        document.getElementById('metaDate').textContent = 'üìÖ ' + (d.validated_at ? new Date(d.validated_at).toLocaleString('pt-BR') : '--');

        updateColor(d.status);
        document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
    }

    // ===================== HIGHLIGHT ON MAP =====================
    // Cores para cada tipo de restri√ß√£o (vermelho = cr√≠tico, laranja = aten√ß√£o)
    const overlapColors = {
        'deforestation_prodes': [239, 68, 68, 0.5],      // Vermelho
        'deforestation_mapbiomas': [239, 68, 68, 0.5],  // Vermelho
        'terra_indigena': [168, 85, 247, 0.5],          // Roxo
        'quilombola': [168, 85, 247, 0.5],              // Roxo
        'embargo_ibama': [239, 68, 68, 0.5],            // Vermelho
        'uc': [245, 158, 11, 0.5],                      // Laranja
        'app_water': [59, 130, 246, 0.5]                // Azul
    };

    const overlapBorderColors = {
        'deforestation_prodes': [239, 68, 68],
        'deforestation_mapbiomas': [239, 68, 68],
        'terra_indigena': [168, 85, 247],
        'quilombola': [168, 85, 247],
        'embargo_ibama': [239, 68, 68],
        'uc': [245, 158, 11],
        'app_water': [59, 130, 246]
    };

    function highlightOnMap(checkType, event) {
        event.stopPropagation(); // Evita fechar o accordion

        // Toast de feedback
        const checkNames = {
            'deforestation_prodes': 'Desmatamento PRODES',
            'deforestation_mapbiomas': 'MapBiomas Alerta',
            'terra_indigena': 'Terras Ind√≠genas',
            'quilombola': 'Quilombolas',
            'uc': 'Unidades de Conserva√ß√£o',
            'embargo_ibama': 'Embargos IBAMA',
            'app_water': 'APP (√Ågua)'
        };

        // Limpar overlaps anteriores
        if (overlapsLayer) {
            overlapsLayer.removeAll();
        }

        // Buscar o check correspondente no resultado da valida√ß√£o
        if (!currentValidationResult || !currentValidationResult.checks) {
            showToast('‚ùå Nenhum resultado de valida√ß√£o dispon√≠vel', 'error');
            return;
        }

        const check = currentValidationResult.checks.find(c => c.check_type === checkType);
        if (!check) {
            showToast('‚ùå Check n√£o encontrado: ' + checkType, 'error');
            return;
        }

        // Verificar se tem geometrias de interse√ß√£o
        const geometries = check.intersection_geometries || [];
        if (geometries.length === 0) {
            showToast('‚ÑπÔ∏è Nenhuma geometria de sobreposi√ß√£o dispon√≠vel', 'info');
            // Ainda faz o flash no pol√≠gono principal
            if (window.flashCurrentGraphic) {
                window.flashCurrentGraphic();
            }
            return;
        }

        // Cores para este tipo de check
        const fillColor = overlapColors[checkType] || [239, 68, 68, 0.5];
        const borderColor = overlapBorderColors[checkType] || [239, 68, 68];

        // Desenhar cada geometria de interse√ß√£o
        let drawnCount = 0;
        geometries.forEach((item, idx) => {
            const geom = item.geometry;
            if (!geom || !geom.type) return;

            try {
                let rings;
                if (geom.type === 'Polygon') {
                    rings = geom.coordinates;
                } else if (geom.type === 'MultiPolygon') {
                    // Para MultiPolygon, desenhar cada pol√≠gono separadamente
                    geom.coordinates.forEach((polyCoords, pIdx) => {
                        drawOverlapPolygon(polyCoords, fillColor, borderColor, item.name, item.overlap_ha, pIdx);
                        drawnCount++;
                    });
                    return;
                } else {
                    console.warn('Tipo de geometria n√£o suportado:', geom.type);
                    return;
                }

                drawOverlapPolygon(rings, fillColor, borderColor, item.name, item.overlap_ha, idx);
                drawnCount++;
            } catch (err) {
                console.error('Erro ao desenhar overlap:', err);
            }
        });

        if (drawnCount > 0) {
            showToast('üó∫Ô∏è ' + (checkNames[checkType] || 'Sobreposi√ß√£o') + ' destacada no mapa (' + drawnCount + ' √°rea' + (drawnCount > 1 ? 's' : '') + ')', 'success');

            // Zoom para mostrar todas as geometrias
            if (window.view && overlapsLayer.graphics.length > 0) {
                const allGraphics = overlapsLayer.graphics.toArray();
                window.view.goTo(allGraphics, {
                    duration: 1000,
                    easing: 'ease-in-out'
                }).catch(() => {});
            }
        } else {
            showToast('‚ö†Ô∏è N√£o foi poss√≠vel desenhar as sobreposi√ß√µes', 'warning');
        }
    }

    // Fun√ß√£o auxiliar para desenhar um pol√≠gono de overlap
    function drawOverlapPolygon(rings, fillColor, borderColor, name, overlapHa, idx) {
        require(["esri/Graphic", "esri/geometry/Polygon"], function(Graphic, Polygon) {
            const poly = new Polygon({
                rings: rings,
                spatialReference: { wkid: 4326 }
            });

            const graphic = new Graphic({
                geometry: poly,
                symbol: {
                    type: "simple-fill",
                    color: fillColor,
                    outline: {
                        color: borderColor,
                        width: 2,
                        style: "solid"
                    }
                },
                attributes: {
                    name: name || 'Sobreposi√ß√£o ' + (idx + 1),
                    overlap_ha: overlapHa || 0
                },
                popupTemplate: {
                    title: "{name}",
                    content: "√Årea de sobreposi√ß√£o: {overlap_ha} ha"
                }
            });

            overlapsLayer.add(graphic);
        });
    }

    // ===================== PDF MODAL =====================
    function openPdfModal() {
        if (!currentPolygon) { showToast('Nenhum pol√≠gono'); return; }
        document.getElementById('pdfModal').classList.add('show');
    }

    function closePdfModal() {
        document.getElementById('pdfModal').classList.remove('show');
    }

    async function downloadPDF() {
        const farmName = document.getElementById('farmName').value.trim();
        const plotName = document.getElementById('plotName').value.trim();

        if (!farmName || !plotName) {
            showToast(window.getAppTranslation ? window.getAppTranslation('fillFarmPlot') : 'Preencha Fazenda e Talh√£o');
            return;
        }

        const langRadio = document.querySelector('input[name="reportLang"]:checked');
        const lang = langRadio ? langRadio.value : 'pt';

        closePdfModal();

        const key = document.getElementById('apiKey').value.trim();
        if (!key) {
            showToast(window.getAppTranslation ? window.getAppTranslation('insertApiKey') : 'Insira sua API Key para gerar o PDF');
            return;
        }

        if (!currentPolygon) { showToast(window.getAppTranslation ? window.getAppTranslation('noPolygon') : 'Nenhum pol√≠gono'); return; }

        const btn = document.getElementById('pdfBtn');
        btn.disabled = true;
        btn.textContent = window.getAppTranslation ? window.getAppTranslation('pdfGenerating') : '‚è≥ Gerando...';

        try {
            const payload = {
                geometry: currentPolygon,
                property_info: {
                    farm_name: farmName,
                    plot_name: plotName,
                    municipality: currentMeta?.municipality || null,
                    state: currentMeta?.state || null
                },
                lang: lang
            };

            const res = await fetch(API_URL + '/api/v1/reports/due-diligence/quick', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': key
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(window.getAppTranslation ? window.getAppTranslation('pdfError') : 'Erro ao gerar PDF');

            const reportCode = res.headers.get('X-Report-Code');
            if (reportCode) console.log('C√≥digo do relat√≥rio:', reportCode);

            const blob = await res.blob();
            const filename = `GreenGate-${farmName.replace(/\s+/g, '-')}-${plotName.replace(/\s+/g, '-')}.pdf`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();

            showToast(window.getAppTranslation ? window.getAppTranslation('pdfSuccess') : 'PDF gerado com sucesso!', 'success');
        } catch (err) {
            showToast(err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'üìÑ Baixar Relat√≥rio PDF';
        }
    }

    document.getElementById('closePdfModal').onclick = closePdfModal;
    document.getElementById('confirmPdfBtn').onclick = downloadPDF;
    document.getElementById('validateBtn').onclick = validate;
    document.getElementById('pdfBtn').onclick = openPdfModal;

    // ===================== REGISTER MODAL =====================
    function openRegisterModal() {
        document.getElementById('registerModal').classList.add('show');
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerError').style.display = 'none';
        document.getElementById('registerSuccess').style.display = 'none';
        document.getElementById('confirmRegisterBtn').disabled = false;
        document.getElementById('confirmRegisterBtn').textContent = 'Criar Minha API Key';
    }

    function closeRegisterModal() {
        document.getElementById('registerModal').classList.remove('show');
    }

    async function registerApiKey() {
        const email = document.getElementById('registerEmail').value.trim();
        const errorEl = document.getElementById('registerError');
        const successEl = document.getElementById('registerSuccess');
        const btn = document.getElementById('confirmRegisterBtn');

        // Validar email
        if (!email || !email.includes('@')) {
            errorEl.textContent = 'Por favor, insira um email v√°lido.';
            errorEl.style.display = 'block';
            successEl.style.display = 'none';
            return;
        }

        // Desabilitar bot√£o
        btn.disabled = true;
        btn.textContent = '‚è≥ Criando...';
        errorEl.style.display = 'none';

        try {
            const res = await fetch(API_URL + '/api/v1/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            });

            const data = await res.json();

            if (!res.ok) {
                const errorMsg = data.detail?.message || data.detail || 'Erro ao criar API key';
                throw new Error(errorMsg);
            }

            // Sucesso! Preencher campo de API key
            document.getElementById('apiKey').value = data.api_key;

            // Salvar se consent foi dado
            if (localStorage.getItem('gg_privacy_consent') === 'accepted') {
                const encrypted = simpleEncrypt(data.api_key);
                if (encrypted) localStorage.setItem('gg_api_key_enc', encrypted);
            }

            // Mostrar sucesso
            successEl.innerHTML = '‚úÖ API Key criada! <strong>Guarde-a em local seguro.</strong><br>Voc√™ tem ' + data.quota + ' valida√ß√µes gratuitas.';
            successEl.style.display = 'block';
            btn.textContent = '‚úÖ Criado!';

            // Fechar modal ap√≥s 3s
            setTimeout(() => {
                closeRegisterModal();
                showToast('üéâ API Key configurada! Voc√™ pode validar √°reas agora.', 'success');
            }, 2500);

        } catch (err) {
            errorEl.textContent = err.message;
            errorEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Criar Minha API Key';
        }
    }

    document.getElementById('getApiKeyBtn').onclick = openRegisterModal;
    document.getElementById('closeRegisterModal').onclick = closeRegisterModal;
    document.getElementById('confirmRegisterBtn').onclick = registerApiKey;

    // Enter para submeter
    document.getElementById('registerEmail').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') registerApiKey();
    });

    // Fechar modal ao clicar fora
    document.getElementById('registerModal').onclick = (e) => {
        if (e.target.id === 'registerModal') closeRegisterModal();
    };
</script>
<script src="app-translations.js"></script>
</body>
</html>
