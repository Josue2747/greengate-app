<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plataforma de Dilig√™ncia Pr√©via Ambiental</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #0a0f1a; --bg-secondary: #111827; --bg-card: #1a2332; --bg-card-hover: #1f2937;
            --border-color: #2d3748; --text-primary: #f3f4f6; --text-secondary: #9ca3af; --text-muted: #6b7280;
            --accent-green: #10b981; --accent-green-dark: #059669; --accent-red: #ef4444; --accent-yellow: #f59e0b; --accent-blue: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 50%, #047857 100%);
            padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: space-between;
            position: relative; z-index: 100; height: 60px;
        }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .logo-text h1 { font-size: 1.1rem; font-weight: 700; }
        .logo-text span { font-size: 0.65rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .status-badge { display: flex; align-items: center; gap: 0.5rem; background: rgba(16, 185, 129, 0.2); border: 1px solid var(--accent-green); padding: 0.3rem 0.6rem; border-radius: 20px; font-size: 0.7rem; }
        .status-dot { width: 6px; height: 6px; background: var(--accent-green); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .help-trigger { width: 28px; height: 28px; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; background: rgba(255,255,255,0.1); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.9rem; font-weight: bold; }
        .help-trigger:hover { background: rgba(255,255,255,0.2); border-color: white; }

        /* LAYOUT */
        .main-container { display: grid; grid-template-columns: 1fr 400px; height: calc(100vh - 60px); }
        .map-container { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }

        /* SEARCH BAR - CENTRALIZADO NO TOPO */
        .search-box {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            width: 320px;
            max-width: calc(100vw - 120px);
        }
        .search-input-wrap {
            position: relative;
            background: rgba(26, 35, 50, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
        }
        .search-input-wrap:focus-within { border-color: var(--accent-green); }
        .search-input-wrap .icon { padding: 0 10px; color: var(--text-muted); }
        .search-input {
            flex: 1;
            padding: 10px 0;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 0.85rem;
            outline: none;
        }
        .search-input::placeholder { color: var(--text-muted); }
        .search-clear {
            padding: 0 10px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: none;
        }
        .search-clear.show { display: block; }
        .search-results {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0; right: 0;
            background: rgba(26, 35, 50, 0.98);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 220px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .search-results.show { display: block; }
        .search-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: var(--bg-card-hover); }
        .search-item-name { font-size: 0.85rem; color: var(--text-primary); }
        .search-item-type { font-size: 0.7rem; color: var(--text-muted); }
        .search-loading, .search-empty { padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; }

        /* MAP CONTROLS */
        .map-controls { position: absolute; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 50; }
        .map-btn { width: 40px; height: 40px; background: rgba(26, 35, 50, 0.95); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .map-btn:hover { background: var(--bg-card-hover); border-color: var(--accent-green); }
        .map-btn.active { background: var(--accent-green); border-color: var(--accent-green); color: white; }
        .draw-options { display: none; position: absolute; left: 48px; top: 0; flex-direction: row; gap: 6px; background: rgba(26, 35, 50, 0.95); padding: 4px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .draw-options.show { display: flex; }
        .draw-options .map-btn { width: 32px; height: 32px; font-size: 0.9rem; box-shadow: none; }
        #fullscreenBtn { display: none; }
        .close-fullscreen { display: none; position: absolute; top: 15px; right: 60px; z-index: 50; width: 40px; height: 40px; background: var(--accent-red); border: none; border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

        /* AREA INFO */
        .area-info { display: none; position: absolute; bottom: 25px; left: 15px; background: rgba(26, 35, 50, 0.95); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px 16px; z-index: 40; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 180px; }
        .area-info.show { display: block; }
        .area-info.limit-exceeded { border-color: var(--accent-red); background: rgba(239, 68, 68, 0.15); }
        .area-info-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .area-info-value { font-size: 1.4rem; font-weight: 700; color: var(--accent-green); margin-top: 4px; }
        .area-info.limit-exceeded .area-info-value { color: var(--accent-red); }
        .area-limit-text { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        .area-info.limit-exceeded .area-limit-text { color: var(--accent-red); font-weight: 600; }
        .area-coords { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; font-family: monospace; }
        .btn-export {
            margin-top: 10px;
            width: 100%;
            padding: 6px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-export:hover { border-color: var(--accent-green); color: var(--accent-green); }

        /* LEGEND */
        .map-legend { position: absolute; bottom: 25px; right: 15px; background: rgba(26, 35, 50, 0.95); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; z-index: 40; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .map-legend-title { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .legend-row { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        .legend-dot { width: 14px; height: 14px; border-radius: 3px; border: 2px solid; }
        .legend-dot.neutral { background: rgba(59,130,246,0.3); border-color: #3b82f6; }
        .legend-dot.approved { background: rgba(16,185,129,0.3); border-color: #10b981; }
        .legend-dot.warning { background: rgba(245,158,11,0.3); border-color: #f59e0b; }
        .legend-dot.rejected { background: rgba(239,68,68,0.3); border-color: #ef4444; }

        /* SIDEBAR */
        .sidebar { background: var(--bg-secondary); border-left: 1px solid var(--border-color); overflow-y: auto; padding: 20px; min-height: 0; }
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .card-title { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .card-title-icon { font-size: 1rem; }
        .card-title-right { margin-left: auto; }

        .input-wrapper { position: relative; }
        .input-wrapper input { width: 100%; padding: 12px 40px 12px 14px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem; }
        .input-wrapper input:focus { outline: none; border-color: var(--accent-green); }
        .input-eye { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; }

        .upload-area { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px 16px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 8px; }
        .upload-area:hover { border-color: var(--accent-green); background: rgba(16,185,129,0.05); }
        .upload-area.has-file { border-color: var(--accent-green); background: rgba(16,185,129,0.1); }
        .upload-area input { display: none; }
        .upload-icon { font-size: 2.5rem; line-height: 1; }
        .upload-text { font-size: 0.875rem; color: var(--text-secondary); }
        .upload-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 0; }
        .upload-filename { display: none; margin-top: 12px; padding: 8px 12px; background: var(--bg-card); border-radius: 6px; font-size: 0.75rem; color: var(--accent-green); word-break: break-all; }
        .upload-filename.show { display: block; }

        .btn-validate { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--accent-green), var(--accent-green-dark)); border: none; border-radius: 10px; color: white; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .btn-validate:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16,185,129,0.3); }
        .btn-validate:disabled { opacity: 0.5; cursor: not-allowed; }

        /* HISTORY */
        .history-list { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
        .history-empty { text-align: center; color: var(--text-muted); font-size: 0.8rem; padding: 15px; }
        .history-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: border-color 0.15s;
        }
        .history-item:hover { border-color: var(--accent-blue); }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .history-status { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; }
        .history-status.approved { background: rgba(16,185,129,0.2); color: var(--accent-green); }
        .history-status.rejected { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        .history-status.warning { background: rgba(245,158,11,0.2); color: var(--accent-yellow); }
        .history-date { font-size: 0.65rem; color: var(--text-muted); }
        .history-info { font-size: 0.75rem; color: var(--text-secondary); }
        .btn-clear-history { background: none; border: none; color: var(--text-muted); font-size: 0.65rem; cursor: pointer; text-decoration: underline; }
        .btn-clear-history:hover { color: var(--accent-red); }

        /* MODAL DE AJUDA */
        .help-modal { display: none; position: fixed; inset: 0; background: rgba(10, 15, 26, 0.85); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .help-modal.show { display: flex; }
        .help-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; width: 100%; max-width: 500px; padding: 30px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-help { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; }
        .help-header { text-align: center; margin-bottom: 30px; }
        .help-icon { font-size: 3rem; margin-bottom: 10px; }
        .help-header h2 { font-size: 1.5rem; color: var(--text-primary); }
        .help-steps { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .step-item { display: flex; gap: 15px; align-items: flex-start; }
        .step-number { background: rgba(16, 185, 129, 0.1); color: var(--accent-green); width: 30px; height: 30px; flex-shrink: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 1px solid var(--accent-green); }
        .step-content h4 { color: var(--text-primary); margin-bottom: 4px; font-size: 1rem; }
        .step-content p { color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; }
        .btn-start { width: 100%; padding: 12px; background: var(--accent-green); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; }

        /* LOADING, RESULTS, CHECKS */
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(10,15,26,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        .loading-overlay.show { display: flex; }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid var(--border-color); border-top-color: var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; color: var(--text-secondary); }
        .loading-step { margin-top: 8px; color: var(--accent-green); font-weight: 500; }

        .result-card { display: none; }
        .result-card.show { display: block; }
        .result-banner { display: flex; align-items: center; gap: 12px; padding: 16px; border-radius: 10px; margin-bottom: 16px; }
        .result-banner.approved { background: rgba(16,185,129,0.15); border: 1px solid var(--accent-green); }
        .result-banner.rejected { background: rgba(239,68,68,0.15); border: 1px solid var(--accent-red); }
        .result-banner.warning { background: rgba(245,158,11,0.15); border: 1px solid var(--accent-yellow); }
        .result-icon { font-size: 2rem; }
        .result-title { font-size: 1.1rem; font-weight: 700; }
        .result-banner.approved .result-title { color: var(--accent-green); }
        .result-banner.rejected .result-title { color: var(--accent-red); }
        .result-banner.warning .result-title { color: var(--accent-yellow); }
        .result-subtitle { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }

        .compliance-section { background: var(--bg-primary); border-radius: 8px; padding: 14px; margin-bottom: 16px; }
        .compliance-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .compliance-bar { height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; }
        .compliance-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .compliance-fill.high { background: var(--accent-green); }
        .compliance-fill.medium { background: var(--accent-yellow); }
        .compliance-fill.low { background: var(--accent-red); }
        .compliance-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: var(--text-muted); }
        .compliance-row strong { font-size: 1.2rem; color: var(--text-primary); }

        .checks-list { display: flex; flex-direction: column; gap: 8px; }
        .check-row { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .check-row.fail { border-color: rgba(239,68,68,0.4); }
        .check-row.warning { border-color: rgba(245,158,11,0.4); }
        .check-header { display: flex; align-items: center; justify-content: space-between; padding: 12px; cursor: pointer; }
        .check-header:hover { background: var(--bg-card); }
        .check-left { display: flex; align-items: center; gap: 10px; }
        .check-status-icon { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .check-status-icon.pass { background: rgba(16,185,129,0.2); color: var(--accent-green); }
        .check-status-icon.fail { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        .check-status-icon.warning { background: rgba(245,158,11,0.2); color: var(--accent-yellow); }
        .check-status-icon.skip { background: rgba(107,114,128,0.2); color: var(--text-muted); }
        .check-name { font-size: 0.85rem; font-weight: 500; }
        .check-right { display: flex; align-items: center; gap: 8px; }
        .check-badge { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; padding: 3px 6px; border-radius: 4px; }
        .check-badge.pass { background: rgba(16,185,129,0.2); color: var(--accent-green); }
        .check-badge.fail { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        .check-badge.warning { background: rgba(245,158,11,0.2); color: var(--accent-yellow); }
        .check-badge.skip { background: rgba(107,114,128,0.2); color: var(--text-muted); }
        .check-arrow { color: var(--text-muted); font-size: 0.7rem; transition: transform 0.2s; }
        .check-row.open .check-arrow { transform: rotate(180deg); }
        .check-details { display: none; padding: 0 12px 12px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }
        .check-row.open .check-details { display: block; }
        .check-overlap-box { background: rgba(239,68,68,0.1); border-left: 3px solid var(--accent-red); padding: 10px; margin-top: 10px; border-radius: 0 6px 6px 0; font-size: 0.75rem; }
        .check-overlap-box strong { color: var(--accent-red); }

        .meta-row { display: flex; justify-content: space-between; padding-top: 12px; margin-top: 12px; border-top: 1px solid var(--border-color); font-size: 0.7rem; color: var(--text-muted); }
        .btn-pdf { width: 100%; padding: 12px; margin-top: 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-pdf:hover { border-color: var(--accent-green); color: var(--accent-green); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent-red); color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.85rem; z-index: 2001; opacity: 0; transition: all 0.3s; }
        .toast.success { background: var(--accent-green); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        body.fullscreen-mode .sidebar { display: none !important; }
        body.fullscreen-mode .main-container { grid-template-columns: 1fr !important; grid-template-rows: 1fr !important; height: 100vh !important; }
        body.fullscreen-mode .header { display: none !important; }
        body.fullscreen-mode .close-fullscreen { display: flex !important; align-items: center; justify-content: center; }

        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; grid-template-rows: 50vh 1fr; }
            .sidebar { border-left: none; border-top: 1px solid var(--border-color); }
            .map-controls { top: 10px; left: 10px; }
            .search-box { left: 50%; transform: translateX(-50%); width: calc(100% - 100px); max-width: 300px; }
            #fullscreenBtn { display: flex; }
            .map-legend { display: none; }
            .logo-text span { display: none; }
        }
    </style>
</head>
<body>
<header class="header" style="position: relative; display: flex; align-items: center; justify-content: center; height: 60px;">
    <div class="logo-icon" style="position: absolute; left: 20px; height: 40px; width: auto; background: transparent;">
        <img src="logo.png" alt="GreenGate" style="height: 40px; width: auto;">
    </div>
    <div class="logo-text" style="text-align: center;">
        <h1 style="margin: 0; line-height: 1.2; font-size: 24px;">GreenGate</h1>
        <span style="font-size: 14px; display: block;">Plataforma de Dilig√™ncia Pr√©via</span>
    </div>
    <div class="header-right" style="position: absolute; right: 20px; display: flex; align-items: center; gap: 15px;">
        <div class="status-badge"><span class="status-dot"></span> API Online</div>
        <button class="help-trigger" id="helpBtn" title="Ajuda">?</button>
    </div>
</header>

<div class="main-container">
    <div class="map-container">
        <div id="map"></div>

        <div class="map-controls">
            <div style="position: relative;">
                <button class="map-btn" id="drawBtn" title="Desenhar">‚úèÔ∏è</button>
                <div class="draw-options" id="drawOptions">
                    <button class="map-btn" id="drawPolygon" title="Pol√≠gono">‚¨°</button>
                    <button class="map-btn" id="drawRect" title="Ret√¢ngulo">‚ñ¢</button>
                </div>
            </div>
            <button class="map-btn" id="clearBtn" title="Limpar">üóëÔ∏è</button>
            <button class="map-btn" id="locateBtn" title="Localiza√ß√£o">üìç</button>
            <button class="map-btn" id="fullscreenBtn" title="Tela Cheia">‚õ∂</button>
        </div>

        <!-- SEARCH -->
        <div class="search-box">
            <div class="search-input-wrap">
                <span class="icon">üîç</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar cidade ou estado...">
                <button class="search-clear" id="searchClear">‚úï</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>

        <button class="close-fullscreen" id="closeFullscreen">‚úï</button>

        <div class="area-info" id="areaInfo">
            <div class="area-info-label">√Årea Selecionada</div>
            <div class="area-info-value"><span id="areaValue">0</span> <span>ha</span></div>
            <div class="area-limit-text">M√°x: 10.000 ha</div>
            <div class="area-coords" id="areaCoords"></div>
            <div class="area-coords" id="areaMeta"></div>
            <button class="btn-export" id="exportBtn">üì• Exportar GeoJSON</button>
        </div>

        <div class="map-legend">
            <div class="map-legend-title">Legenda</div>
            <div class="legend-row"><div class="legend-dot neutral"></div>Selecionada</div>
            <div class="legend-row"><div class="legend-dot approved"></div>Conforme</div>
            <div class="legend-row"><div class="legend-dot warning"></div>Aten√ß√£o</div>
            <div class="legend-row"><div class="legend-dot rejected"></div>N√£o conforme</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <div class="card-title"><span class="card-title-icon">üîë</span> Autentica√ß√£o</div>
            <div class="input-wrapper">
                <input type="password" id="apiKey" placeholder="Cole sua API Key">
                <button class="input-eye" id="toggleKey">üëÅÔ∏è</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title"><span class="card-title-icon">üìÅ</span> Upload de Arquivo</div>
            <label class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".json,.geojson">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Toque para selecionar</div>
                <div class="upload-hint">GeoJSON ou JSON</div>
            </label>
            <div class="upload-filename" id="fileName"></div>

            <button class="btn-export" id="testExampleBtn" style="margin-top: 10px; background: var(--accent-blue); color: white; border-color: var(--accent-blue);">
                üéØ Testar com √Årea de Exemplo
            </button>
        </div>

        <button class="btn-validate" id="validateBtn" disabled>üîç Validar √Årea</button>

        <div class="card result-card" id="resultCard">
            <div class="result-banner" id="resultBanner">
                <div class="result-icon" id="resultIcon">‚úì</div>
                <div>
                    <div class="result-title" id="resultTitle">Conforme</div>
                    <div class="result-subtitle" id="resultSubtitle">Conformidade: --/100</div>
                </div>
            </div>
            <div class="compliance-section">
                <div class="compliance-label">Conformidade (0‚Äì100 ‚Ä¢ quanto maior, melhor)</div>
                <div class="compliance-bar"><div class="compliance-fill" id="complianceFill"></div></div>
                <div class="compliance-row">
                    <span><strong id="complianceValue">--</strong>/100</span>
                    <span id="complianceLabel">--</span>
                </div>
            </div>
            <div class="checks-list" id="checksList"></div>
            <div class="meta-row">
                <span id="metaTime">‚è±Ô∏è --ms</span>
                <span id="metaDate">üìÖ --/--/----</span>
            </div>
            <button class="btn-pdf" id="pdfBtn">üìÑ Baixar Relat√≥rio PDF</button>
        </div>

        <!-- HISTORY -->
        <div class="card">
            <div class="card-title">
                <span><span class="card-title-icon">üìã</span> Hist√≥rico</span>
                <button class="btn-clear-history card-title-right" id="clearHistory">Limpar</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="history-empty">Nenhuma valida√ß√£o</div>
            </div>
        </div>
    </div>
</div>

<div class="help-modal" id="helpModal">
    <div class="help-card">
        <button class="close-help" id="closeHelp">‚úï</button>
        <div class="help-header">
            <div class="help-icon">üöÄ</div>
            <h2>Como usar o GreenGate</h2>
        </div>
        <div class="help-steps">
            <div class="step-item">
                <div class="step-number">1</div>
                <div class="step-content"><h4>Autentica√ß√£o</h4><p>Insira sua <strong>API Key</strong> no painel lateral.</p></div>
            </div>
            <div class="step-item">
                <div class="step-number">2</div>
                <div class="step-content"><h4>Navegue no Mapa</h4><p>Use a <strong>busca</strong> para encontrar cidades ou estados.</p></div>
            </div>
            <div class="step-item">
                <div class="step-number">3</div>
                <div class="step-content"><h4>Defina a √Årea</h4><p>Use o <strong>L√°pis (‚úèÔ∏è)</strong> para desenhar ou fa√ßa <strong>Upload</strong>. <br><span style="color:var(--accent-yellow); font-size:0.75rem;">Limite: 10.000 hectares.</span></p></div>
            </div>
            <div class="step-item">
                <div class="step-number">4</div>
                <div class="step-content"><h4>Valida√ß√£o</h4><p>Clique em <strong>Validar √Årea</strong> para gerar o relat√≥rio.</p></div>
            </div>
        </div>
        <button class="btn-start" id="startBtn">Come√ßar a Usar</button>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Validando √°rea...</div>
    <div class="loading-step" id="loadingStep">Conectando</div>
</div>

<div class="toast" id="toast"></div>

<!-- Modal Info Relat√≥rio -->
<div class="help-modal" id="pdfModal">
    <div class="help-card" style="max-width: 420px;">
        <button class="close-help" id="closePdfModal">‚úï</button>
        <div class="help-header" style="margin-bottom: 20px;">
            <div class="help-icon">üìÑ</div>
            <h2 style="font-size: 1.2rem;">Gerar Relat√≥rio PDF</h2>
        </div>
        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
            <div>
                <label style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Nome da Fazenda *</label>
                <input type="text" id="farmName" placeholder="Ex: Fazenda Santa Maria" style="width: 100%; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem;">
            </div>
            <div>
                <label style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Nome do Talh√£o *</label>
                <input type="text" id="plotName" placeholder="Ex: Talh√£o 01 - Soja" style="width: 100%; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem;">
            </div>
            <div>
                <label style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Idioma do Relat√≥rio</label>
                <div style="display: flex; gap: 10px;">
                    <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="reportLang" value="pt" checked style="accent-color: var(--accent-green);">
                        <span>üáßüá∑ Portugu√™s</span>
                    </label>
                    <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="reportLang" value="en" style="accent-color: var(--accent-green);">
                        <span>üá∫üá∏ English</span>
                    </label>
                </div>
            </div>
        </div>
        <p style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 15px; text-align: center;">
            üì± O relat√≥rio incluir√° QR Code para verifica√ß√£o de autenticidade
        </p>
        <button class="btn-start" id="confirmPdfBtn">üìÑ Gerar Relat√≥rio PDF</button>
    </div>
</div>

<script src="https://js.arcgis.com/4.28/"></script>
<script>
    const API_URL = 'https://api.greengate.com.br';
    const MAX_HISTORY = 5;

    let map, view, graphicsLayer, sketchVM, currentPolygon = null, currentGraphic = null, geoEngine, webMercatorUtils;
    let searchTimeout = null;

    // meta da √°rea (para PDF / UI)
    let currentMeta = { municipality: null, state: null, address: null };

    // ===================== HELPERS =====================
    function clampConf(x) {
        const n = Number(x);
        if (!Number.isFinite(n)) return 0;
        return Math.max(0, Math.min(100, n));
    }

    function confLabel(conf) {
        if (conf >= 90) return 'Excelente';
        if (conf >= 70) return 'Bom';
        if (conf >= 40) return 'Regular';
        return 'Cr√≠tico';
    }

    function fmtCheckType(c) {
        return {
            deforestation_prodes: 'Desmatamento PRODES',
            deforestation_mapbiomas: 'Alertas MapBiomas',
            terra_indigena: 'Terras Ind√≠genas',
            embargo_ibama: 'Embargos IBAMA',
            quilombola: 'Quilombolas',
            uc: 'Unidades de Conserva√ß√£o',
            app_water: 'APP Hidrografia'
        }[c] || c;
    }

    function fmtCheckStatusBadge(s) {
        return {
            pass: 'Conforme',
            fail: 'N√£o conforme',
            warning: 'Aten√ß√£o',
            skip: 'N/A'
        }[s] || s;
    }

    function fmtHistoryStatusLabel(s) {
        return s === 'approved' ? 'OK' : s === 'rejected' ? 'FAIL' : 'WARN';
    }

    function showToast(m, t = 'error') {
        const el = document.getElementById('toast');
        el.textContent = typeof m === 'object' ? (m.detail || m.message || 'Erro') : m;
        el.className = 'toast ' + t;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 4000);
    }

    function setValidateAvailability() {
        const ai = document.getElementById('areaInfo');
        const overLimit = ai.classList.contains('limit-exceeded');
        document.getElementById('validateBtn').disabled = !(currentPolygon && !overLimit);
    }

    // ===================== HISTORY =====================
    function getHistory() {
        try { return JSON.parse(localStorage.getItem('gg_history') || '[]'); }
        catch { return []; }
    }

    function saveHistory(result, area) {
        const conf = clampConf(result.risk_score);
        const h = getHistory();
        h.unshift({
            id: Date.now(),
            status: result.status,
            score: conf,
            area: area,
            date: new Date().toISOString(),
            polygon: currentPolygon,
            meta: currentMeta
        });
        if (h.length > MAX_HISTORY) h.pop();
        localStorage.setItem('gg_history', JSON.stringify(h));
        renderHistory();
    }

    function renderHistory() {
        const el = document.getElementById('historyList');
        const h = getHistory();
        if (!h.length) { el.innerHTML = '<div class="history-empty">Nenhuma valida√ß√£o</div>'; return; }
        el.innerHTML = h.map(i => `
            <div class="history-item" data-id="${i.id}">
                <div class="history-header">
                    <span class="history-status ${i.status}">${fmtHistoryStatusLabel(i.status)}</span>
                    <span class="history-date">${new Date(i.date).toLocaleDateString('pt-BR')}</span>
                </div>
                <div class="history-info">${i.area.toFixed(1)} ha ‚Ä¢ Conformidade: ${i.score}/100</div>
            </div>
        `).join('');
        el.querySelectorAll('.history-item').forEach(item => {
            item.onclick = () => {
                const found = h.find(x => x.id === +item.dataset.id);
                if (found?.polygon) {
                    currentMeta = found.meta || { municipality: null, state: null, address: null };
                    loadGeoJSON(found.polygon);
                    showToast('Pol√≠gono carregado', 'success');
                }
            };
        });
    }

    // ===================== CLEAR =====================
    function clearAll() {
        if (sketchVM) sketchVM.cancel();
        currentPolygon = null; currentGraphic = null;
        currentMeta = { municipality: null, state: null, address: null };

        if (graphicsLayer) graphicsLayer.removeAll();

        const ai = document.getElementById('areaInfo');
        ai.classList.remove('show', 'limit-exceeded');

        document.getElementById('areaValue').textContent = '0';
        document.getElementById('areaCoords').textContent = '';
        document.getElementById('areaMeta').textContent = '';

        document.getElementById('resultCard').classList.remove('show');
        document.getElementById('uploadArea').classList.remove('has-file');
        document.getElementById('fileName').classList.remove('show');
        document.getElementById('fileInput').value = '';
        document.getElementById('drawBtn').classList.remove('active');
        document.getElementById('drawOptions').classList.remove('show');

        setValidateAvailability();
    }

    // ===================== INIT =====================
    document.addEventListener('DOMContentLoaded', () => {
        const k = localStorage.getItem('gg_api_key');
        if (k) document.getElementById('apiKey').value = k;
        renderHistory();
        if (!localStorage.getItem('gg_tutorial')) setTimeout(() => document.getElementById('helpModal').classList.add('show'), 1000);
    });

    // ===================== ESRI =====================
    require([
        "esri/Map", "esri/views/MapView", "esri/layers/GraphicsLayer",
        "esri/widgets/Sketch/SketchViewModel", "esri/Graphic",
        "esri/geometry/geometryEngine", "esri/geometry/Polygon",
        "esri/widgets/BasemapGallery", "esri/widgets/Expand",
        "esri/geometry/support/webMercatorUtils", "esri/rest/locator"
    ], function(Map, MapView, GraphicsLayer, SketchVM, Graphic, geoEng, Polygon, BasemapGallery, Expand, wmUtils, locator) {

        geoEngine = geoEng; webMercatorUtils = wmUtils;

        map = new Map({ basemap: "hybrid" });
        view = new MapView({
            container: "map",
            map,
            center: [-55.5, -12.5],
            zoom: 6,
            ui: { padding: { bottom: 200 } }
        });

        view.ui.move("zoom", "bottom-right");
        view.ui.add(new Expand({
            view,
            content: new BasemapGallery({ view }),
            expandIconClass: "esri-icon-basemap",
            autoCollapse: true
        }), "top-right");

        graphicsLayer = new GraphicsLayer();
        map.add(graphicsLayer);

        sketchVM = new SketchVM({
            view,
            layer: graphicsLayer,
            polygonSymbol: {
                type: "simple-fill",
                color: [59,130,246,0.3],
                outline: { color: [59,130,246], width: 2 }
            }
        });

        // ========= flash polygon (feedback visual ao clicar checks) =========
        window.flashCurrentGraphic = () => {
            if (!currentGraphic) return;
            const original = currentGraphic.symbol;
            const outline = (original && original.outline) ? original.outline : { color: [255,255,255,1], width: 2 };
            currentGraphic.symbol = {
                type: "simple-fill",
                color: original?.color || [59,130,246,0.3],
                outline: { color: outline.color, width: 5 }
            };
            setTimeout(() => { if (currentGraphic) currentGraphic.symbol = original; }, 250);
        };

        // ========== SEARCH ==========
        const GEOCODE = "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer";
        const sInput = document.getElementById('searchInput');
        const sResults = document.getElementById('searchResults');
        const sClear = document.getElementById('searchClear');

        let lastSearchResults = [];

        sInput.oninput = (e) => {
            const q = e.target.value.trim();
            sClear.classList.toggle('show', q.length > 0);
            if (searchTimeout) clearTimeout(searchTimeout);
            if (q.length < 2) { sResults.classList.remove('show'); return; }

            sResults.innerHTML = '<div class="search-loading">Buscando...</div>';
            sResults.classList.add('show');

            searchTimeout = setTimeout(() => {
                locator.addressToLocations(GEOCODE, {
                    address: { SingleLine: q + ", Brasil" },
                    countryCode: "BRA",
                    maxLocations: 5,
                    outFields: ["Addr_type", "City", "Region"]
                }).then(res => {
                    lastSearchResults = res || [];
                    if (!res.length) { sResults.innerHTML = '<div class="search-empty">Nenhum resultado</div>'; return; }
                    sResults.innerHTML = res.map((r, i) => `
                        <div class="search-item" data-i="${i}">
                            <div class="search-item-name">${r.address}</div>
                            <div class="search-item-type">${r.attributes.Addr_type || 'Local'}</div>
                        </div>
                    `).join('');
                    sResults.querySelectorAll('.search-item').forEach(el => {
                        el.onclick = () => {
                            const r = res[+el.dataset.i];
                            view.goTo({
                                center: [r.location.longitude, r.location.latitude],
                                zoom: r.attributes.Addr_type === 'Locality' ? 12 : 8
                            });
                            sInput.value = r.address;
                            sResults.classList.remove('show');
                        };
                    });
                }).catch(() => sResults.innerHTML = '<div class="search-empty">Erro na busca</div>');
            }, 350);
        };

        sInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && lastSearchResults.length) {
                const r = lastSearchResults[0];
                view.goTo({
                    center: [r.location.longitude, r.location.latitude],
                    zoom: r.attributes.Addr_type === 'Locality' ? 12 : 8
                });
                sInput.value = r.address;
                sResults.classList.remove('show');
            }
        });

        sClear.onclick = () => {
            sInput.value = '';
            sClear.classList.remove('show');
            sResults.classList.remove('show');
        };

        document.addEventListener('click', e => {
            if (!e.target.closest('.search-box')) sResults.classList.remove('show');
        });

        // ========== reverse geocode ==========
        async function fillMetaFromGeometry(geo) {
            try {
                if (!geo?.centroid) return;
                let c = geo.centroid;
                if (c.spatialReference?.isWebMercator) c = webMercatorUtils.webMercatorToGeographic(c);

                const resp = await locator.locationToAddress(GEOCODE, {
                    location: c,
                    outFields: ["City", "Region", "Subregion", "Neighborhood"],
                    langCode: "pt"
                });

                const attrs = resp?.attributes || {};
                const municipality = attrs.City || null;
                const state = attrs.Region || null;

                currentMeta = {
                    municipality,
                    state,
                    address: resp?.address || null
                };

                const metaEl = document.getElementById('areaMeta');
                const parts = [];
                if (municipality) parts.push(municipality);
                if (state) parts.push(state);
                metaEl.textContent = parts.length ? parts.join(' ‚Ä¢ ') : '';
            } catch (_) {
                // silencioso
            }
        }

        // ========== AREA ==========
        const checkArea = (geo) => {
            if (!geo) return false;
            const area = Math.abs(geoEngine.geodesicArea(geo, "square-meters")) / 10000;
            const c = geo.centroid;
            const ai = document.getElementById('areaInfo');

            document.getElementById('areaValue').textContent = area.toFixed(2);
            document.getElementById('areaCoords').textContent = c ? `${c.latitude.toFixed(5)}, ${c.longitude.toFixed(5)}` : '';
            ai.classList.add('show');

            if (area > 10000) {
                ai.classList.add('limit-exceeded');
                setValidateAvailability();
                return false;
            }
            ai.classList.remove('limit-exceeded');
            setValidateAvailability();
            return true;
        };

        sketchVM.on(["create", "update"], e => {
            if (e.state === "active") checkArea(e.graphic.geometry);

            if (e.state === "complete") {
                currentGraphic = e.graphic;

                let geo = e.graphic.geometry;
                if (geo.spatialReference?.isWebMercator) geo = webMercatorUtils.webMercatorToGeographic(geo);

                const simp = geoEngine.simplify(geo) || geo;
                currentPolygon = { type: "Polygon", coordinates: simp.rings };

                document.getElementById('drawOptions').classList.remove('show');
                document.getElementById('drawBtn').classList.remove('active');

                const ok = checkArea(simp);
                if (ok) fillMetaFromGeometry(simp);
            }
        });

        window.loadGeoJSON = (geom) => {
            clearAll();
            const poly = new Polygon({ rings: geom.coordinates, spatialReference: { wkid: 4326 } });
            const g = new Graphic({
                geometry: poly,
                symbol: { type: "simple-fill", color: [59,130,246,0.3], outline: { color: [59,130,246], width: 2 } }
            });

            graphicsLayer.add(g);
            currentGraphic = g;
            view.goTo(g.geometry.extent.expand(1.5));

            currentPolygon = geom;

            const ok = checkArea(poly);
            if (ok) fillMetaFromGeometry(poly);
        };

        window.updateColor = (s) => {
            if (!currentGraphic) return;
            const c = {
                approved: [[16,185,129,0.3],[16,185,129]],
                rejected: [[239,68,68,0.3],[239,68,68]],
                warning: [[245,158,11,0.3],[245,158,11]]
            }[s] || [[59,130,246,0.3],[59,130,246]];

            currentGraphic.symbol = { type: "simple-fill", color: c[0], outline: { color: c[1], width: 2 } };
        };

        // ========== BUTTONS ==========
        document.getElementById('drawBtn').onclick = e => {
            e.preventDefault();
            if (sketchVM.state === "active") sketchVM.cancel();
            document.getElementById('drawOptions').classList.toggle('show');
            document.getElementById('drawBtn').classList.toggle('active');
        };

        document.getElementById('drawPolygon').onclick = e => {
            e.preventDefault();
            clearAll();
            sketchVM.create("polygon");
            document.getElementById('drawOptions').classList.remove('show');
        };

        document.getElementById('drawRect').onclick = e => {
            e.preventDefault();
            clearAll();
            sketchVM.create("rectangle");
            document.getElementById('drawOptions').classList.remove('show');
        };

        document.getElementById('clearBtn').onclick = e => { e.preventDefault(); clearAll(); };

        document.getElementById('locateBtn').onclick = e => {
            e.preventDefault();
            navigator.geolocation?.getCurrentPosition(p => view.goTo({ center: [p.coords.longitude, p.coords.latitude], zoom: 14 }));
        };

        document.getElementById('fullscreenBtn').onclick = e => {
            e.preventDefault();
            document.body.classList.add('fullscreen-mode');
            setTimeout(() => view.requestResize(), 100);
        };

        document.getElementById('closeFullscreen').onclick = e => {
            e.preventDefault();
            document.body.classList.remove('fullscreen-mode');
            view.requestResize();
        };
    });

    // ===================== EXPORT GEOJSON =====================
    document.getElementById('exportBtn').onclick = () => {
        if (!currentPolygon) { showToast('Nenhum pol√≠gono'); return; }
        const gj = { type: "Feature", properties: { source: "GreenGate", exported: new Date().toISOString() }, geometry: currentPolygon };
        const blob = new Blob([JSON.stringify(gj, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `area-${Date.now()}.geojson`; a.click();
        showToast('GeoJSON exportado!', 'success');
    };

    // ===================== UI =====================
    const modal = document.getElementById('helpModal');
    const toggleModal = s => { s ? modal.classList.add('show') : (modal.classList.remove('show'), localStorage.setItem('gg_tutorial', '1')); };
    document.getElementById('helpBtn').onclick = () => toggleModal(true);
    document.getElementById('closeHelp').onclick = () => toggleModal(false);
    document.getElementById('startBtn').onclick = () => toggleModal(false);

    document.getElementById('clearHistory').onclick = () => {
        if (confirm('Limpar hist√≥rico?')) { localStorage.removeItem('gg_history'); renderHistory(); }
    };

    document.getElementById('toggleKey').onclick = e => {
        e.preventDefault();
        const i = document.getElementById('apiKey');
        i.type = i.type === 'password' ? 'text' : 'password';
        e.target.textContent = i.type === 'password' ? 'üëÅÔ∏è' : 'üîí';
    };

    document.getElementById('fileInput').onchange = e => {
        const f = e.target.files[0]; if (!f) return;
        document.getElementById('fileName').textContent = f.name;
        document.getElementById('fileName').classList.add('show');
        document.getElementById('uploadArea').classList.add('has-file');

        const r = new FileReader();
        r.onload = ev => {
            try {
                const j = JSON.parse(ev.target.result);
                loadGeoJSON(j.type === 'FeatureCollection' ? j.features[0].geometry : j.type === 'Feature' ? j.geometry : j);
            } catch (err) { showToast('Erro: ' + err.message); }
        };
        r.readAsText(f);
    };

    // ===================== TESTE COM EXEMPLO =====================
    document.getElementById('testExampleBtn').onclick = () => {
        // √Årea de exemplo: ~500 ha no Mato Grosso (regi√£o de Sinop)
        const exampleGeometry = {
            type: "Polygon",
            coordinates: [[
                [-55.52, -11.86],
                [-55.48, -11.86],
                [-55.48, -11.88],
                [-55.52, -11.88],
                [-55.52, -11.86]
            ]]
        };

        loadGeoJSON(exampleGeometry);
        document.getElementById('fileName').textContent = 'üìç √Årea de Exemplo (Sinop, MT)';
        document.getElementById('fileName').classList.add('show');
        document.getElementById('uploadArea').classList.add('has-file');
        showToast('√Årea de exemplo carregada! Clique em "Validar √Årea" para testar.', 'success');
    };

    // ===================== VALIDATE =====================
    async function validate() {
        const key = document.getElementById('apiKey').value.trim();

        // Permitir 1 valida√ß√£o gr√°tis sem API Key
        const freeValidations = parseInt(localStorage.getItem('gg_free_validations') || '0');

        if (!key && freeValidations >= 1) {
            showToast('Voc√™ j√° usou sua valida√ß√£o gr√°tis! Adquira uma API Key para continuar.', 'error');
            // Aqui voc√™ pode mostrar um modal de pre√ßos depois
            return;
        }

        if (!currentPolygon) { showToast('Desenhe ou carregue um pol√≠gono'); return; }

        localStorage.setItem('gg_api_key', key);

        document.getElementById('loadingOverlay').classList.add('show');
        document.getElementById('validateBtn').disabled = true;

        const steps = ['Analisando PRODES...', 'Verificando MapBiomas...', 'Consultando TIs...', 'Verificando Embargos...', 'Analisando UCs...', 'Processando...'];
        let i = 0;
        const iv = setInterval(() => { if (i < steps.length) document.getElementById('loadingStep').textContent = steps[i++]; }, 2000);

        try {
            const res = await fetch(API_URL + '/api/v1/validations/quick', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': key },
                body: JSON.stringify(currentPolygon)
            });

            clearInterval(iv);
            const data = await res.json();
            if (!res.ok) throw new Error(typeof data.detail === 'string' ? data.detail : Array.isArray(data.detail) ? data.detail.map(e => e.msg).join(', ') : 'Erro');

            // Contar valida√ß√£o gr√°tis se n√£o tiver API Key
            if (!key) {
                localStorage.setItem('gg_free_validations', '1');
                showToast('‚úÖ Valida√ß√£o gr√°tis utilizada! Para mais valida√ß√µes, adquira uma API Key.', 'success');
            }

            saveHistory(data, parseFloat(document.getElementById('areaValue').textContent));
            showResult(data);

        } catch (err) {
            clearInterval(iv);
            showToast(err.message);

        } finally {
            document.getElementById('loadingOverlay').classList.remove('show');
            setValidateAvailability(); // N√ÉO reabilitar se estiver acima do limite
        }
    }

    function showResult(d) {
        document.getElementById('resultCard').classList.add('show');
        document.getElementById('resultBanner').className = 'result-banner ' + d.status;

        document.getElementById('resultIcon').textContent = d.status === 'approved' ? '‚úì' : d.status === 'rejected' ? '‚úó' : '‚ö†';
        document.getElementById('resultTitle').textContent = d.status === 'approved' ? 'Conforme' : d.status === 'rejected' ? 'N√£o Conforme' : 'Aten√ß√£o';

        const conf = clampConf(d.risk_score);
        const label = confLabel(conf);

        document.getElementById('resultSubtitle').textContent = `Conformidade: ${conf}/100 ‚Ä¢ ${label}`;

        const fill = document.getElementById('complianceFill');
        fill.style.width = conf + '%';
        fill.className = 'compliance-fill ' + (conf >= 70 ? 'high' : conf >= 40 ? 'medium' : 'low');

        document.getElementById('complianceValue').textContent = conf;
        document.getElementById('complianceLabel').textContent = label;

        const list = document.getElementById('checksList');
        list.innerHTML = '';

        (d.checks || []).forEach(c => {
            const icon = c.status === 'pass' ? '‚úì' : c.status === 'fail' ? '‚úó' : c.status === 'warning' ? '‚ö†' : '‚óã';

            let det = '<p>' + (c.message || '') + '</p>';
            if ((c.overlap_area_ha || 0) > 0) {
                det += '<div class="check-overlap-box"><strong>Sobreposi√ß√£o:</strong> ' +
                    Number(c.overlap_area_ha).toFixed(2) +
                    ' ha (' + Number(c.overlap_percentage || 0).toFixed(1) + '%)</div>';
            }

            const row = document.createElement('div');
            row.className = 'check-row ' + (c.status || 'skip');

            row.innerHTML =
                `<div class="check-header" onclick="this.parentElement.classList.toggle('open'); window.flashCurrentGraphic && window.flashCurrentGraphic();">
                    <div class="check-left">
                        <div class="check-status-icon ${c.status || 'skip'}">${icon}</div>
                        <span class="check-name">${fmtCheckType(c.check_type)}</span>
                    </div>
                    <div class="check-right">
                        <span class="check-badge ${c.status || 'skip'}">${fmtCheckStatusBadge(c.status)}</span>
                        <span class="check-arrow">‚ñº</span>
                    </div>
                </div>
                <div class="check-details">${det}</div>`;

            list.appendChild(row);
        });

        document.getElementById('metaTime').textContent = '‚è±Ô∏è ' + (d.processing_time_ms ?? '--') + 'ms';
        document.getElementById('metaDate').textContent = 'üìÖ ' + (d.validated_at ? new Date(d.validated_at).toLocaleString('pt-BR') : '--');

        updateColor(d.status);
        document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
    }

    // ===================== PDF MODAL =====================
    function openPdfModal() {
        if (!currentPolygon) { showToast('Nenhum pol√≠gono'); return; }
        document.getElementById('pdfModal').classList.add('show');
    }

    function closePdfModal() {
        document.getElementById('pdfModal').classList.remove('show');
    }

    async function downloadPDF() {
        const farmName = document.getElementById('farmName').value.trim();
        const plotName = document.getElementById('plotName').value.trim();

        if (!farmName || !plotName) {
            showToast('Preencha Fazenda e Talh√£o');
            return;
        }

        const langRadio = document.querySelector('input[name="reportLang"]:checked');
        const lang = langRadio ? langRadio.value : 'pt';

        closePdfModal();

        const key = document.getElementById('apiKey').value.trim();
        if (!key) { showToast('Insira a API Key'); return; }
        if (!currentPolygon) { showToast('Nenhum pol√≠gono'); return; }

        const btn = document.getElementById('pdfBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Gerando...';

        try {
            const payload = {
                geometry: currentPolygon,
                property_info: {
                    farm_name: farmName,
                    plot_name: plotName,
                    municipality: currentMeta?.municipality || null,
                    state: currentMeta?.state || null
                },
                lang: lang
            };

            const res = await fetch(API_URL + '/api/v1/reports/due-diligence/quick', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': key },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error('Erro ao gerar PDF');

            const reportCode = res.headers.get('X-Report-Code');
            if (reportCode) console.log('C√≥digo do relat√≥rio:', reportCode);

            const blob = await res.blob();
            const filename = `GreenGate-${farmName.replace(/\s+/g, '-')}-${plotName.replace(/\s+/g, '-')}.pdf`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();

            showToast('PDF gerado com sucesso!', 'success');
        } catch (err) {
            showToast(err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'üìÑ Baixar Relat√≥rio PDF';
        }
    }

    document.getElementById('closePdfModal').onclick = closePdfModal;
    document.getElementById('confirmPdfBtn').onclick = downloadPDF;
    document.getElementById('validateBtn').onclick = validate;
    document.getElementById('pdfBtn').onclick = openPdfModal;
</script>
</body>
</html>
