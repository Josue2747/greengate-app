<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GreenGate - Geo-Compliance Platform</title>
    
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --bg-card-hover: #1f2937;
            --border-color: #2d3748;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-green: #10b981;
            --accent-green-dark: #059669;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-blue: #3b82f6;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 50%, #047857 100%);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 100;
            height: 60px;
        }

        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon {
            width: 36px; height: 36px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }
        .logo-text h1 { font-size: 1.1rem; font-weight: 700; }
        .logo-text span { font-size: 0.65rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; }

        .status-badge {
            display: flex; align-items: center; gap: 0.5rem;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--accent-green);
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.7rem;
        }
        .status-dot {
            width: 6px; height: 6px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* LAYOUT */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: calc(100vh - 60px);
        }

        /* MAP */
        .map-container { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }

        /* CONTROLS */
        .map-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 50;
        }

        .map-btn {
            width: 40px; height: 40px;
            background: rgba(26, 35, 50, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .map-btn:hover { background: var(--bg-card-hover); border-color: var(--accent-green); }
        .map-btn.active { background: var(--accent-green); border-color: var(--accent-green); color: white; }

        .draw-options {
            display: none;
            position: absolute;
            left: 48px;
            top: 0;
            flex-direction: row;
            gap: 6px;
            background: rgba(26, 35, 50, 0.95);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .draw-options.show { display: flex; }
        .draw-options .map-btn { width: 32px; height: 32px; font-size: 0.9rem; box-shadow: none; }

        #fullscreenBtn { display: none; }

        .close-fullscreen {
            display: none;
            position: absolute;
            top: 15px;
            right: 60px;
            z-index: 50;
            width: 40px; height: 40px;
            background: var(--accent-red);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* AREA INFO */
        .area-info {
            display: none;
            position: absolute;
            bottom: 25px;
            left: 15px;
            background: rgba(26, 35, 50, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 16px;
            z-index: 40;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 180px;
        }
        .area-info.show { display: block; }
        .area-info-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .area-info-value { font-size: 1.4rem; font-weight: 700; color: var(--accent-green); margin-top: 4px; }
        .area-info-value span { font-size: 0.85rem; font-weight: 400; color: var(--text-secondary); }
        .area-info-coords { font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; font-family: monospace; }

        /* LEGEND */
        .map-legend {
            position: absolute;
            bottom: 25px;
            right: 15px;
            background: rgba(26, 35, 50, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            z-index: 40;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .map-legend-title { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .legend-row { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        .legend-dot { width: 14px; height: 14px; border-radius: 3px; border: 2px solid; }
        .legend-dot.neutral { background: rgba(59,130,246,0.3); border-color: #3b82f6; }
        .legend-dot.approved { background: rgba(16,185,129,0.3); border-color: #10b981; }
        .legend-dot.warning { background: rgba(245,158,11,0.3); border-color: #f59e0b; }
        .legend-dot.rejected { background: rgba(239,68,68,0.3); border-color: #ef4444; }

        /* SIDEBAR */
        .sidebar {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 20px;
            min-height: 0; 
        }

        /* CARDS & INPUTS */
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .card-title { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .card-title-icon { font-size: 1rem; }
        .input-wrapper { position: relative; }
        .input-wrapper input { width: 100%; padding: 12px 40px 12px 14px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem; }
        .input-wrapper input:focus { outline: none; border-color: var(--accent-green); }
        .input-eye { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; }

        /* UPLOAD */
        .upload-area { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px 16px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 8px; }
        .upload-area:hover { border-color: var(--accent-green); background: rgba(16,185,129,0.05); }
        .upload-area.has-file { border-color: var(--accent-green); background: rgba(16,185,129,0.1); }
        .upload-area input { display: none; }
        .upload-icon { font-size: 2.5rem; line-height: 1; }
        .upload-text { font-size: 0.875rem; color: var(--text-secondary); }
        .upload-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 0; }
        .upload-filename { display: none; margin-top: 12px; padding: 8px 12px; background: var(--bg-card); border-radius: 6px; font-size: 0.75rem; color: var(--accent-green); word-break: break-all; }
        .upload-filename.show { display: block; }

        /* BUTTON */
        .btn-validate { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--accent-green), var(--accent-green-dark)); border: none; border-radius: 10px; color: white; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .btn-validate:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16,185,129,0.3); }
        .btn-validate:disabled { opacity: 0.5; cursor: not-allowed; }

        /* UI ELEMENTS */
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(10,15,26,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        .loading-overlay.show { display: flex; }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid var(--border-color); border-top-color: var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; color: var(--text-secondary); }
        .loading-step { margin-top: 8px; color: var(--accent-green); font-weight: 500; }

        .result-card { display: none; }
        .result-card.show { display: block; }
        .result-banner { display: flex; align-items: center; gap: 12px; padding: 16px; border-radius: 10px; margin-bottom: 16px; }
        .result-banner.approved { background: rgba(16,185,129,0.15); border: 1px solid var(--accent-green); }
        .result-banner.rejected { background: rgba(239,68,68,0.15); border: 1px solid var(--accent-red); }
        .result-banner.warning { background: rgba(245,158,11,0.15); border: 1px solid var(--accent-yellow); }
        .result-icon { font-size: 2rem; }
        .result-title { font-size: 1.1rem; font-weight: 700; }
        .result-banner.approved .result-title { color: var(--accent-green); }
        .result-banner.rejected .result-title { color: var(--accent-red); }
        .result-banner.warning .result-title { color: var(--accent-yellow); }
        .result-subtitle { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }

        .compliance-section { background: var(--bg-primary); border-radius: 8px; padding: 14px; margin-bottom: 16px; }
        .compliance-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .compliance-bar { height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; }
        .compliance-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .compliance-fill.high { background: var(--accent-green); }
        .compliance-fill.medium { background: var(--accent-yellow); }
        .compliance-fill.low { background: var(--accent-red); }
        .compliance-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: var(--text-muted); }
        .compliance-row strong { font-size: 1.2rem; color: var(--text-primary); }

        .checks-list { display: flex; flex-direction: column; gap: 8px; }
        .check-row { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .check-row.fail { border-color: rgba(239,68,68,0.4); }
        .check-row.warning { border-color: rgba(245,158,11,0.4); }
        .check-header { display: flex; align-items: center; justify-content: space-between; padding: 12px; cursor: pointer; }
        .check-header:hover { background: var(--bg-card); }
        .check-left { display: flex; align-items: center; gap: 10px; }
        .check-status-icon { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .check-status-icon.pass { background: rgba(16,185,129,0.2); color: var(--accent-green); }
        .check-status-icon.fail { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        .check-status-icon.warning { background: rgba(245,158,11,0.2); color: var(--accent-yellow); }
        .check-status-icon.skip { background: rgba(107,114,128,0.2); color: var(--text-muted); }
        .check-name { font-size: 0.85rem; font-weight: 500; }
        .check-right { display: flex; align-items: center; gap: 8px; }
        .check-badge { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; padding: 3px 6px; border-radius: 4px; }
        .check-badge.pass { background: rgba(16,185,129,0.2); color: var(--accent-green); }
        .check-badge.fail { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        .check-badge.warning { background: rgba(245,158,11,0.2); color: var(--accent-yellow); }
        .check-badge.skip { background: rgba(107,114,128,0.2); color: var(--text-muted); }
        .check-arrow { color: var(--text-muted); font-size: 0.7rem; transition: transform 0.2s; }
        .check-row.open .check-arrow { transform: rotate(180deg); }
        .check-details { display: none; padding: 0 12px 12px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }
        .check-row.open .check-details { display: block; }
        .check-overlap-box { background: rgba(239,68,68,0.1); border-left: 3px solid var(--accent-red); padding: 10px; margin-top: 10px; border-radius: 0 6px 6px 0; font-size: 0.75rem; }
        .check-overlap-box strong { color: var(--accent-red); }

        .meta-row { display: flex; justify-content: space-between; padding-top: 12px; margin-top: 12px; border-top: 1px solid var(--border-color); font-size: 0.7rem; color: var(--text-muted); }
        .btn-pdf { width: 100%; padding: 12px; margin-top: 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-pdf:hover { border-color: var(--accent-green); color: var(--accent-green); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent-red); color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.85rem; z-index: 1001; opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* FULLSCREEN MODE LOGIC */
        body.fullscreen-mode .sidebar { display: none !important; }
        body.fullscreen-mode .main-container { grid-template-columns: 1fr !important; grid-template-rows: 1fr !important; height: 100vh !important; }
        body.fullscreen-mode .header { display: none !important; }
        body.fullscreen-mode .close-fullscreen { display: flex !important; align-items: center; justify-content: center; }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; grid-template-rows: 50vh 1fr; }
            .sidebar { border-left: none; border-top: 1px solid var(--border-color); }
            .map-controls { top: 10px; left: 10px; }
            #fullscreenBtn { display: flex; }
            .map-legend { display: none; }
            .logo-text span { display: none; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üåø</div>
            <div class="logo-text">
                <h1>GreenGate</h1>
                <span>Geo-Compliance Platform</span>
            </div>
        </div>
        <div class="status-badge">
            <span class="status-dot"></span>
            API Online
        </div>
    </header>
    
    <div class="main-container">
        <div class="map-container">
            <div id="map"></div>
            
            <div class="map-controls">
                <div style="position: relative;">
                    <button class="map-btn" id="drawBtn" title="Desenhar">‚úèÔ∏è</button>
                    <div class="draw-options" id="drawOptions">
                        <button class="map-btn" id="drawPolygon" title="Pol√≠gono">‚¨°</button>
                        <button class="map-btn" id="drawRect" title="Ret√¢ngulo">‚ñ¢</button>
                    </div>
                </div>
                <button class="map-btn" id="clearBtn" title="Limpar">üóëÔ∏è</button>
                <button class="map-btn" id="locateBtn" title="Localiza√ß√£o">üìç</button>
                <button class="map-btn" id="fullscreenBtn" title="Tela Cheia">‚õ∂</button>
            </div>
            
            <button class="close-fullscreen" id="closeFullscreen">‚úï</button>
            
            <div class="area-info" id="areaInfo">
                <div class="area-info-label">√Årea Selecionada</div>
                <div class="area-info-value"><span id="areaValue">0</span> <span>ha</span></div>
                <div class="area-info-coords" id="areaCoords">--.----, --.----</div>
            </div>
            
            <div class="map-legend">
                <div class="map-legend-title">Legenda</div>
                <div class="legend-row"><div class="legend-dot neutral"></div>Selecionada</div>
                <div class="legend-row"><div class="legend-dot approved"></div>Conforme</div>
                <div class="legend-row"><div class="legend-dot warning"></div>Aten√ß√£o</div>
                <div class="legend-row"><div class="legend-dot rejected"></div>N√£o conforme</div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="card">
                <div class="card-title"><span class="card-title-icon">üîë</span> Autentica√ß√£o</div>
                <div class="input-wrapper">
                    <input type="password" id="apiKey" placeholder="Cole sua API Key">
                    <button class="input-eye" id="toggleKey">üëÅÔ∏è</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title"><span class="card-title-icon">üìÅ</span> Upload de Arquivo</div>
                <label class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".json,.geojson">
                    <div class="upload-icon">üìÑ</div>
                    <div class="upload-text">Toque para selecionar</div>
                    <div class="upload-hint">GeoJSON ou JSON</div>
                </label>
                <div class="upload-filename" id="fileName"></div>
            </div>
            
            <button class="btn-validate" id="validateBtn" disabled>
                üîç Validar √Årea
            </button>
            
            <div class="card result-card" id="resultCard">
                <div class="result-banner" id="resultBanner">
                    <div class="result-icon" id="resultIcon">‚úì</div>
                    <div>
                        <div class="result-title" id="resultTitle">Conforme</div>
                        <div class="result-subtitle" id="resultSubtitle">√çndice: 100</div>
                    </div>
                </div>
                
                <div class="compliance-section">
                    <div class="compliance-label">√çndice de Conformidade</div>
                    <div class="compliance-bar"><div class="compliance-fill" id="complianceFill"></div></div>
                    <div class="compliance-row">
                        <span><strong id="complianceValue">100</strong>/100</span>
                        <span id="complianceLabel">Excelente</span>
                    </div>
                </div>
                
                <div class="checks-list" id="checksList"></div>
                
                <div class="meta-row">
                    <span id="metaTime">‚è±Ô∏è --ms</span>
                    <span id="metaDate">üìÖ --/--/----</span>
                </div>
                
                <button class="btn-pdf" id="pdfBtn">üìÑ Baixar Relat√≥rio PDF</button>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Validando √°rea...</div>
        <div class="loading-step" id="loadingStep">Conectando</div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script src="https://js.arcgis.com/4.28/"></script>
    <script>
        const API_URL = 'https://greengate-production.up.railway.app';
        let map, view, graphicsLayer, sketchVM, currentPolygon = null, currentGraphic = null, geoEngine, webMercatorUtils;
        
        function clearAll() {
            // FIX CR√çTICO: Cancela qualquer desenho ativo para destravar o mapa
            if (sketchVM) sketchVM.cancel();
            
            currentPolygon = null;
            currentGraphic = null;
            if (graphicsLayer) graphicsLayer.removeAll();
            document.getElementById('areaInfo').classList.remove('show');
            document.getElementById('resultCard').classList.remove('show');
            document.getElementById('validateBtn').disabled = true;
            document.getElementById('uploadArea').classList.remove('has-file');
            document.getElementById('fileName').classList.remove('show');
            document.getElementById('fileInput').value = '';
            document.getElementById('drawBtn').classList.remove('active');
            document.getElementById('drawOptions').classList.remove('show');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('greengate_api_key');
            if (savedKey) document.getElementById('apiKey').value = savedKey;
        });
        
        require([
            "esri/Map", "esri/views/MapView", "esri/layers/GraphicsLayer",
            "esri/widgets/Sketch/SketchViewModel", "esri/Graphic",
            "esri/geometry/geometryEngine", "esri/geometry/Polygon",
            "esri/widgets/BasemapGallery", "esri/widgets/Expand",
            "esri/geometry/support/webMercatorUtils"
        ], function(Map, MapView, GraphicsLayer, SketchViewModel, Graphic, geometryEngine, Polygon, BasemapGallery, Expand, WebMercatorUtils) {
            geoEngine = geometryEngine;
            webMercatorUtils = WebMercatorUtils;
            
            map = new Map({ basemap: "satellite" });
            
            view = new MapView({ 
                container: "map", 
                map: map, 
                center: [-55.5, -12.5], 
                zoom: 6,
                ui: { padding: { bottom: 200 } }
            });
            
            view.ui.move("zoom", "bottom-right");
            
            const bg = new BasemapGallery({ view: view });
            const bgExpand = new Expand({
                view: view, content: bg, expandIconClass: "esri-icon-basemap", autoCollapse: true
            });
            view.ui.add(bgExpand, "top-right");

            graphicsLayer = new GraphicsLayer();
            map.add(graphicsLayer);
            
            sketchVM = new SketchViewModel({
                view: view, layer: graphicsLayer,
                polygonSymbol: { type: "simple-fill", color: [59,130,246,0.3], outline: { color: [59,130,246], width: 2 } }
            });

            const calculateAndShowArea = (geometry) => {
                if (!geometry) return;
                const simplified = geoEngine.simplify(geometry);
                const area = Math.abs(geoEngine.geodesicArea(simplified, "square-meters")) / 10000;
                const c = simplified.extent.center; 
                document.getElementById('areaValue').textContent = area.toFixed(2);
                document.getElementById('areaCoords').textContent = c.latitude.toFixed(4) + ', ' + c.longitude.toFixed(4);
                document.getElementById('areaInfo').classList.add('show');
            };

            sketchVM.on(["create", "update"], function(e) {
                if (e.state === "active" || e.state === "complete") {
                    calculateAndShowArea(e.graphic.geometry);
                }

                if (e.state === "complete") {
                    currentGraphic = e.graphic;
                    let finalGeo = e.graphic.geometry;
                    if (finalGeo.spatialReference.isWebMercator) {
                        finalGeo = webMercatorUtils.webMercatorToGeographic(finalGeo);
                    }
                    const simplifiedGeo = geoEngine.simplify(finalGeo);
                    currentPolygon = { type: "Polygon", coordinates: simplifiedGeo.rings };
                    document.getElementById('drawOptions').classList.remove('show');
                    document.getElementById('drawBtn').classList.remove('active');
                    document.getElementById('validateBtn').disabled = false;
                }
            });
            
            window.loadGeoJSON = function(geom) {
                clearAll();
                const poly = new Polygon({ rings: geom.coordinates, spatialReference: { wkid: 4326 } });
                const g = new Graphic({ geometry: poly, symbol: { type: "simple-fill", color: [59,130,246,0.3], outline: { color: [59,130,246], width: 2 } } });
                graphicsLayer.add(g);
                currentGraphic = g;
                view.goTo(g.geometry.extent.expand(1.5));
                calculateAndShowArea(poly);
                currentPolygon = geom;
                document.getElementById('validateBtn').disabled = false;
            };
            
            window.updateColor = function(status) {
                if (!currentGraphic) return;
                const c = { approved: [[16,185,129,0.3],[16,185,129]], rejected: [[239,68,68,0.3],[239,68,68]], warning: [[245,158,11,0.3],[245,158,11]] };
                const col = c[status] || c.approved;
                currentGraphic.symbol = { type: "simple-fill", color: col[0], outline: { color: col[1], width: 2 } };
            };
            
            // Buttons and Draw Logic
            document.getElementById('drawBtn').onclick = function(e) {
                e.preventDefault();
                // FIX: Cancela se estiver desenhando para n√£o travar
                if (sketchVM.state === "active") sketchVM.cancel();
                
                const opts = document.getElementById('drawOptions');
                opts.classList.toggle('show');
                this.classList.toggle('active');
            };
            
            document.getElementById('drawPolygon').onclick = function(e) { 
                e.preventDefault(); 
                clearAll(); 
                sketchVM.create("polygon"); 
                document.getElementById('drawOptions').classList.remove('show'); 
            };
            
            document.getElementById('drawRect').onclick = function(e) { 
                e.preventDefault(); 
                clearAll(); 
                sketchVM.create("rectangle"); 
                document.getElementById('drawOptions').classList.remove('show'); 
            };
            
            document.getElementById('clearBtn').onclick = function(e) { 
                e.preventDefault(); 
                clearAll(); 
            };
            
            document.getElementById('locateBtn').onclick = function(e) {
                e.preventDefault();
                navigator.geolocation && navigator.geolocation.getCurrentPosition(p => view.goTo({ center: [p.coords.longitude, p.coords.latitude], zoom: 14 }));
            };
            
            document.getElementById('fullscreenBtn').onclick = function(e) { 
                e.preventDefault(); 
                document.body.classList.add('fullscreen-mode'); 
                // Delay para garantir que o CSS aplicou antes do resize
                setTimeout(() => view.requestResize(), 100);
            };
            
            document.getElementById('closeFullscreen').onclick = function(e) { 
                e.preventDefault(); 
                document.body.classList.remove('fullscreen-mode'); 
                // Delay duplo para garantir que o layout voltou
                view.requestResize();
                setTimeout(() => view.requestResize(), 50);
            };
        });
        
        document.getElementById('toggleKey').onclick = function(e) {
            e.preventDefault();
            const inp = document.getElementById('apiKey');
            inp.type = inp.type === 'password' ? 'text' : 'password';
            this.textContent = inp.type === 'password' ? 'üëÅÔ∏è' : 'üîí';
        };
        
        document.getElementById('fileInput').onchange = function(e) {
            const f = e.target.files[0];
            if (!f) return;
            document.getElementById('fileName').textContent = f.name;
            document.getElementById('fileName').classList.add('show');
            document.getElementById('uploadArea').classList.add('has-file');
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const json = JSON.parse(ev.target.result);
                    let geom;
                    if (json.type === 'FeatureCollection') geom = json.features[0].geometry;
                    else if (json.type === 'Feature') geom = json.geometry;
                    else geom = json;
                    loadGeoJSON(geom);
                } catch (err) { showToast('Erro: ' + err.message); }
            };
            reader.readAsText(f);
        };
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            let displayText = msg;
            if (typeof msg === 'object') {
                displayText = msg.detail || msg.message || "Erro desconhecido";
            }
            t.textContent = displayText;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 4000);
        }
        
        function formatCheck(c) {
            const n = { deforestation_prodes: 'Desmatamento PRODES', deforestation_mapbiomas: 'Alertas MapBiomas', terra_indigena: 'Terras Ind√≠genas', embargo_ibama: 'Embargos IBAMA', quilombola: 'Quilombolas', uc: 'Unidades de Conserva√ß√£o', app_water: 'APP Hidrografia' };
            return n[c] || c;
        }
        
        async function validate() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) { showToast('Insira a API Key'); return; }
            if (!currentPolygon) { showToast('Desenhe ou carregue um pol√≠gono'); return; }
            localStorage.setItem('greengate_api_key', key);
            
            document.getElementById('loadingOverlay').classList.add('show');
            document.getElementById('validateBtn').disabled = true;
            
            const steps = ['Analisando PRODES...', 'Verificando MapBiomas...', 'Consultando TIs...', 'Verificando Embargos...', 'Analisando UCs...', 'Processando...'];
            let i = 0;
            const iv = setInterval(() => { if (i < steps.length) document.getElementById('loadingStep').textContent = steps[i++]; }, 2000);
            
            try {
                const res = await fetch(API_URL + '/api/v1/validations/quick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': key },
                    body: JSON.stringify(currentPolygon)
                });
                clearInterval(iv);
                const data = await res.json();
                
                if (!res.ok) {
                    let errorMsg = 'Erro na valida√ß√£o';
                    if (data.detail) {
                        if (typeof data.detail === 'string') errorMsg = data.detail;
                        else if (Array.isArray(data.detail)) errorMsg = data.detail.map(e => e.msg).join(', ');
                        else errorMsg = JSON.stringify(data.detail);
                    }
                    throw new Error(errorMsg);
                }
                showResult(data);
            } catch (err) { 
                clearInterval(iv); 
                showToast(err.message || err); 
            } 
            finally { 
                document.getElementById('loadingOverlay').classList.remove('show'); 
                document.getElementById('validateBtn').disabled = false; 
            }
        }
        
        function showResult(d) {
            document.getElementById('resultCard').classList.add('show');
            const banner = document.getElementById('resultBanner');
            banner.className = 'result-banner ' + d.status;
            document.getElementById('resultIcon').textContent = d.status === 'approved' ? '‚úì' : d.status === 'rejected' ? '‚úó' : '‚ö†';
            document.getElementById('resultTitle').textContent = d.status === 'approved' ? 'Conforme' : d.status === 'rejected' ? 'N√£o Conforme' : 'Aten√ß√£o';
            document.getElementById('resultSubtitle').textContent = '√çndice: ' + d.risk_score;
            
            const fill = document.getElementById('complianceFill');
            fill.style.width = d.risk_score + '%';
            fill.className = 'compliance-fill ' + (d.risk_score >= 70 ? 'high' : d.risk_score >= 40 ? 'medium' : 'low');
            document.getElementById('complianceValue').textContent = d.risk_score;
            document.getElementById('complianceLabel').textContent = d.risk_score >= 90 ? 'Excelente' : d.risk_score >= 70 ? 'Bom' : d.risk_score >= 40 ? 'Regular' : 'Cr√≠tico';
            
            const list = document.getElementById('checksList');
            list.innerHTML = '';
            d.checks.forEach(c => {
                const s = c.status;
                const icon = s === 'pass' ? '‚úì' : s === 'fail' ? '‚úó' : s === 'warning' ? '‚ö†' : '‚óã';
                let details = '<p>' + c.message + '</p>';
                if (c.overlap_area_ha > 0) details += '<div class="check-overlap-box"><strong>Sobreposi√ß√£o:</strong> ' + c.overlap_area_ha.toFixed(2) + ' ha (' + c.overlap_percentage.toFixed(1) + '%)</div>';
                const row = document.createElement('div');
                row.className = 'check-row ' + s;
                row.innerHTML = '<div class="check-header" onclick="this.parentElement.classList.toggle(\'open\')"><div class="check-left"><div class="check-status-icon ' + s + '">' + icon + '</div><span class="check-name">' + formatCheck(c.check_type) + '</span></div><div class="check-right"><span class="check-badge ' + s + '">' + s + '</span><span class="check-arrow">‚ñº</span></div></div><div class="check-details">' + details + '</div>';
                list.appendChild(row);
            });
            document.getElementById('metaTime').textContent = '‚è±Ô∏è ' + d.processing_time_ms + 'ms';
            document.getElementById('metaDate').textContent = 'üìÖ ' + new Date(d.validated_at).toLocaleString('pt-BR');
            updateColor(d.status);
            document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function downloadPDF() {
            const key = document.getElementById('apiKey').value.trim();
            if (!currentPolygon) { showToast('Nenhum pol√≠gono'); return; }
            const btn = document.getElementById('pdfBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Gerando...';
            try {
                const res = await fetch(API_URL + '/api/v1/reports/due-diligence/quick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': key },
                    body: JSON.stringify(currentPolygon)
                });
                if (!res.ok) throw new Error('Erro ao gerar PDF');
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'greengate-report.pdf';
                a.click();
                URL.revokeObjectURL(url);
            } catch (err) { showToast(err.message); }
            finally { btn.disabled = false; btn.textContent = 'üìÑ Baixar Relat√≥rio PDF'; }
        }
        
        document.getElementById('validateBtn').onclick = validate;
        document.getElementById('pdfBtn').onclick = downloadPDF;
    </script>
</body>
</html>
