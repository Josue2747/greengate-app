<script src="https://js.arcgis.com/4.28/"></script>
    <script>
        const API_URL = 'https://greengate-production.up.railway.app';
        let map, view, graphicsLayer, sketchVM, currentPolygon = null, currentGraphic = null, geoEngine, webMercatorUtils;
        
        // Fun√ß√£o para limpar tudo
        function clearAll() {
            currentPolygon = null;
            currentGraphic = null;
            if (graphicsLayer) graphicsLayer.removeAll();
            document.getElementById('areaInfo').classList.remove('show');
            document.getElementById('resultCard').classList.remove('show');
            document.getElementById('validateBtn').disabled = true;
            document.getElementById('uploadArea').classList.remove('has-file');
            document.getElementById('fileName').classList.remove('show');
            document.getElementById('fileInput').value = '';
            document.getElementById('drawBtn').classList.remove('active');
            document.getElementById('drawOptions').classList.remove('show');
        }
        
        // Restaurar API Key salva
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('greengate_api_key');
            if (savedKey) document.getElementById('apiKey').value = savedKey;
        });
        
        require([
            "esri/Map", "esri/views/MapView", "esri/layers/GraphicsLayer",
            "esri/widgets/Sketch/SketchViewModel", "esri/Graphic",
            "esri/geometry/geometryEngine", "esri/geometry/Polygon",
            "esri/widgets/BasemapGallery", "esri/widgets/Expand",
            "esri/geometry/support/webMercatorUtils" // Necess√°rio para converter o desenho para o formato da API
        ], function(Map, MapView, GraphicsLayer, SketchViewModel, Graphic, geometryEngine, Polygon, BasemapGallery, Expand, WebMercatorUtils) {
            geoEngine = geometryEngine;
            webMercatorUtils = WebMercatorUtils;
            
            map = new Map({ basemap: "satellite" });
            
            // AQUI EST√Å A CORRE√á√ÉO DO PADDING E POSI√á√ÉO DO ZOOM
            view = new MapView({ 
                container: "map", 
                map: map, 
                center: [-55.5, -12.5], 
                zoom: 6,
                ui: { padding: { bottom: 120 } } // Empurra o zoom para cima da legenda
            });
            
            // Move o zoom para baixo na direita
            view.ui.move("zoom", "bottom-right");
            
            // Bot√£o de Layers (Sat√©lite/H√≠brido/etc) no topo direito
            const bg = new BasemapGallery({ view: view });
            const bgExpand = new Expand({
                view: view, content: bg, expandIconClass: "esri-icon-basemap", autoCollapse: true
            });
            view.ui.add(bgExpand, "top-right");

            graphicsLayer = new GraphicsLayer();
            map.add(graphicsLayer);
            
            sketchVM = new SketchViewModel({
                view: view, layer: graphicsLayer,
                polygonSymbol: { type: "simple-fill", color: [59,130,246,0.3], outline: { color: [59,130,246], width: 2 } }
            });

            // --- L√ìGICA DE ATUALIZA√á√ÉO DA √ÅREA EM TEMPO REAL ---
            
            // Fun√ß√£o auxiliar para calcular e mostrar √°rea
            const calculateAndShowArea = (geometry) => {
                if (!geometry) return;
                
                // Simplifica geometria para evitar erros de c√°lculo
                const simplified = geoEngine.simplify(geometry);
                
                // Calcula √°rea (funciona mesmo se estiver desenhando)
                const area = Math.abs(geoEngine.geodesicArea(simplified, "square-meters")) / 10000;
                
                // Pega o centro para mostrar as coordenadas
                const c = simplified.extent.center; 
                
                document.getElementById('areaValue').textContent = area.toFixed(2);
                document.getElementById('areaCoords').textContent = c.latitude.toFixed(4) + ', ' + c.longitude.toFixed(4);
                document.getElementById('areaInfo').classList.add('show');
            };

            // Eventos do Sketch (L√°pis/Quadrado)
            sketchVM.on(["create", "update"], function(e) {
                // Atualiza a √°rea ENQUANTO desenha (state: active) ou ao terminar (state: complete)
                if (e.state === "active" || e.state === "complete") {
                    calculateAndShowArea(e.graphic.geometry);
                }

                // Quando termina o desenho, prepara para valida√ß√£o
                if (e.state === "complete") {
                    currentGraphic = e.graphic;
                    
                    // Converte de WebMercator (Mapa) para Geogr√°fico (API exige isso)
                    let finalGeo = e.graphic.geometry;
                    if (finalGeo.spatialReference.isWebMercator) {
                        finalGeo = webMercatorUtils.webMercatorToGeographic(finalGeo);
                    }
                    
                    // Garante que √© um pol√≠gono v√°lido
                    const simplifiedGeo = geoEngine.simplify(finalGeo);
                    currentPolygon = { type: "Polygon", coordinates: simplifiedGeo.rings };
                    
                    document.getElementById('drawOptions').classList.remove('show');
                    document.getElementById('drawBtn').classList.remove('active');
                    document.getElementById('validateBtn').disabled = false;
                }
            });
            
            // Fun√ß√£o para carregar arquivo (Upload)
            window.loadGeoJSON = function(geom) {
                clearAll();
                const poly = new Polygon({ rings: geom.coordinates, spatialReference: { wkid: 4326 } });
                const g = new Graphic({ geometry: poly, symbol: { type: "simple-fill", color: [59,130,246,0.3], outline: { color: [59,130,246], width: 2 } } });
                graphicsLayer.add(g);
                currentGraphic = g;
                view.goTo(g.geometry.extent.expand(1.5));
                
                // Calcula √°rea do upload
                calculateAndShowArea(poly);
                currentPolygon = geom; // J√° est√° no formato certo vindo do JSON
                document.getElementById('validateBtn').disabled = false;
            };
            
            // Muda cor do pol√≠gono ap√≥s valida√ß√£o
            window.updateColor = function(status) {
                if (!currentGraphic) return;
                const c = { approved: [[16,185,129,0.3],[16,185,129]], rejected: [[239,68,68,0.3],[239,68,68]], warning: [[245,158,11,0.3],[245,158,11]] };
                const col = c[status] || c.approved;
                currentGraphic.symbol = { type: "simple-fill", color: col[0], outline: { color: col[1], width: 2 } };
            };
            
            // Bot√µes e A√ß√µes da Interface
            document.getElementById('drawBtn').onclick = function(e) {
                e.preventDefault();
                const opts = document.getElementById('drawOptions');
                opts.classList.toggle('show');
                this.classList.toggle('active');
            };
            document.getElementById('drawPolygon').onclick = function(e) { e.preventDefault(); clearAll(); sketchVM.create("polygon"); document.getElementById('drawOptions').classList.remove('show'); };
            document.getElementById('drawRect').onclick = function(e) { e.preventDefault(); clearAll(); sketchVM.create("rectangle"); document.getElementById('drawOptions').classList.remove('show'); };
            document.getElementById('clearBtn').onclick = function(e) { e.preventDefault(); clearAll(); };
            
            document.getElementById('locateBtn').onclick = function(e) {
                e.preventDefault();
                navigator.geolocation && navigator.geolocation.getCurrentPosition(p => view.goTo({ center: [p.coords.longitude, p.coords.latitude], zoom: 14 }));
            };
            
            // Fullscreen Mobile
            document.getElementById('fullscreenBtn').onclick = function(e) { 
                e.preventDefault(); 
                document.body.classList.add('fullscreen-mode'); 
                setTimeout(() => view.requestResize(), 100);
            };
            document.getElementById('closeFullscreen').onclick = function(e) { 
                e.preventDefault(); 
                document.body.classList.remove('fullscreen-mode'); 
                setTimeout(() => view.requestResize(), 100);
            };
        });
        
        // Toggle senha da API
        document.getElementById('toggleKey').onclick = function(e) {
            e.preventDefault();
            const inp = document.getElementById('apiKey');
            inp.type = inp.type === 'password' ? 'text' : 'password';
            this.textContent = inp.type === 'password' ? 'üëÅÔ∏è' : 'üîí';
        };
        
        // Input de Arquivo
        document.getElementById('fileInput').onchange = function(e) {
            const f = e.target.files[0];
            if (!f) return;
            document.getElementById('fileName').textContent = f.name;
            document.getElementById('fileName').classList.add('show');
            document.getElementById('uploadArea').classList.add('has-file');
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const json = JSON.parse(ev.target.result);
                    let geom;
                    if (json.type === 'FeatureCollection') geom = json.features[0].geometry;
                    else if (json.type === 'Feature') geom = json.geometry;
                    else geom = json;
                    loadGeoJSON(geom);
                } catch (err) { showToast('Erro: ' + err.message); }
            };
            reader.readAsText(f);
        };
        
        // Toast (Mensagens)
        function showToast(msg) {
            const t = document.getElementById('toast');
            // Corre√ß√£o para n√£o mostrar [object Object]
            let displayText = msg;
            if (typeof msg === 'object') {
                displayText = msg.detail || msg.message || "Erro desconhecido";
            }
            t.textContent = displayText;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 4000);
        }
        
        // Tradutor de nomes dos checks
        function formatCheck(c) {
            const n = { deforestation_prodes: 'Desmatamento PRODES', deforestation_mapbiomas: 'Alertas MapBiomas', terra_indigena: 'Terras Ind√≠genas', embargo_ibama: 'Embargos IBAMA', quilombola: 'Quilombolas', uc: 'Unidades de Conserva√ß√£o', app_water: 'APP Hidrografia' };
            return n[c] || c;
        }
        
        // Valida√ß√£o (Chamada API)
        async function validate() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) { showToast('Insira a API Key'); return; }
            if (!currentPolygon) { showToast('Desenhe ou carregue um pol√≠gono'); return; }
            localStorage.setItem('greengate_api_key', key);
            
            document.getElementById('loadingOverlay').classList.add('show');
            document.getElementById('validateBtn').disabled = true;
            
            const steps = ['Analisando PRODES...', 'Verificando MapBiomas...', 'Consultando TIs...', 'Verificando Embargos...', 'Analisando UCs...', 'Processando...'];
            let i = 0;
            const iv = setInterval(() => { if (i < steps.length) document.getElementById('loadingStep').textContent = steps[i++]; }, 2000);
            
            try {
                const res = await fetch(API_URL + '/api/v1/validations/quick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': key },
                    body: JSON.stringify(currentPolygon)
                });
                clearInterval(iv);
                const data = await res.json();
                
                if (!res.ok) {
                    // Tratamento detalhado de erro da API
                    let errorMsg = 'Erro na valida√ß√£o';
                    if (data.detail) {
                        if (typeof data.detail === 'string') errorMsg = data.detail;
                        else if (Array.isArray(data.detail)) errorMsg = data.detail.map(e => e.msg).join(', ');
                        else errorMsg = JSON.stringify(data.detail);
                    }
                    throw new Error(errorMsg);
                }
                
                showResult(data);
            } catch (err) { 
                clearInterval(iv); 
                showToast(err.message || err); 
            } 
            finally { 
                document.getElementById('loadingOverlay').classList.remove('show'); 
                document.getElementById('validateBtn').disabled = false; 
            }
        }
        
        // Exibir Resultados
        function showResult(d) {
            document.getElementById('resultCard').classList.add('show');
            const banner = document.getElementById('resultBanner');
            banner.className = 'result-banner ' + d.status;
            document.getElementById('resultIcon').textContent = d.status === 'approved' ? '‚úì' : d.status === 'rejected' ? '‚úó' : '‚ö†';
            document.getElementById('resultTitle').textContent = d.status === 'approved' ? 'Conforme' : d.status === 'rejected' ? 'N√£o Conforme' : 'Aten√ß√£o';
            document.getElementById('resultSubtitle').textContent = '√çndice: ' + d.risk_score;
            
            const fill = document.getElementById('complianceFill');
            fill.style.width = d.risk_score + '%';
            fill.className = 'compliance-fill ' + (d.risk_score >= 70 ? 'high' : d.risk_score >= 40 ? 'medium' : 'low');
            document.getElementById('complianceValue').textContent = d.risk_score;
            document.getElementById('complianceLabel').textContent = d.risk_score >= 90 ? 'Excelente' : d.risk_score >= 70 ? 'Bom' : d.risk_score >= 40 ? 'Regular' : 'Cr√≠tico';
            
            const list = document.getElementById('checksList');
            list.innerHTML = '';
            d.checks.forEach(c => {
                const s = c.status;
                const icon = s === 'pass' ? '‚úì' : s === 'fail' ? '‚úó' : s === 'warning' ? '‚ö†' : '‚óã';
                let details = '<p>' + c.message + '</p>';
                if (c.overlap_area_ha > 0) details += '<div class="check-overlap-box"><strong>Sobreposi√ß√£o:</strong> ' + c.overlap_area_ha.toFixed(2) + ' ha (' + c.overlap_percentage.toFixed(1) + '%)</div>';
                const row = document.createElement('div');
                row.className = 'check-row ' + s;
                row.innerHTML = '<div class="check-header" onclick="this.parentElement.classList.toggle(\'open\')"><div class="check-left"><div class="check-status-icon ' + s + '">' + icon + '</div><span class="check-name">' + formatCheck(c.check_type) + '</span></div><div class="check-right"><span class="check-badge ' + s + '">' + s + '</span><span class="check-arrow">‚ñº</span></div></div><div class="check-details">' + details + '</div>';
                list.appendChild(row);
            });
            
            document.getElementById('metaTime').textContent = '‚è±Ô∏è ' + d.processing_time_ms + 'ms';
            document.getElementById('metaDate').textContent = 'üìÖ ' + new Date(d.validated_at).toLocaleString('pt-BR');
            updateColor(d.status);
            document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Download PDF
        async function downloadPDF() {
            const key = document.getElementById('apiKey').value.trim();
            if (!currentPolygon) { showToast('Nenhum pol√≠gono'); return; }
            const btn = document.getElementById('pdfBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Gerando...';
            try {
                const res = await fetch(API_URL + '/api/v1/reports/due-diligence/quick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': key },
                    body: JSON.stringify(currentPolygon)
                });
                if (!res.ok) throw new Error('Erro ao gerar PDF');
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'greengate-report.pdf';
                a.click();
                URL.revokeObjectURL(url);
            } catch (err) { showToast(err.message); }
            finally { btn.disabled = false; btn.textContent = 'üìÑ Baixar Relat√≥rio PDF'; }
        }
        
        document.getElementById('validateBtn').onclick = validate;
        document.getElementById('pdfBtn').onclick = downloadPDF;
    </script>
